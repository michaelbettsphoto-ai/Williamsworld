<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>William's World - Quest Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@700;900&family=Permanent+Marker&display=swap" rel="stylesheet">
</head>
<body>

<style>
  :root{
    --bg0:#1a0e2e; --bg1:#1c1028; --panel:rgba(30,15,40,0.85); --ink:#fff5e6; --muted:#e6d4b8;
    --line:#c8942a; --gold:#ffd36e; --green:#7dffb4; --blue:#d4a530;
    --purple:#7c3aed; --orange:#ff9d5c; --red:#dc2626; 
    --golden-border:#d4a530; --warm-glow:rgba(212,165,48,0.6);
    --shadow:0 18px 60px rgba(0,0,0,.45); --r1:22px; --r2:16px; --pad:16px; --max:1280px;
    --font:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    --fantasy-font:'Cinzel', 'MedievalSharp', serif;
    --glass-bg:rgba(20,10,35,.25);
    --glass-blur:blur(18px) saturate(1.3);
    --glass-strong-bg:rgba(20,10,35,.35);
  }
  
  /* Animated background */
  @keyframes starfield {
    0%, 100% { opacity: .3; transform: scale(1); }
    50% { opacity: .8; transform: scale(1.1); }
  }
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .6; }
  }
  @keyframes glow {
    0%, 100% { box-shadow: 0 0 10px rgba(255,211,110,.3), 0 0 20px rgba(255,211,110,.2); }
    50% { box-shadow: 0 0 20px rgba(255,211,110,.6), 0 0 40px rgba(255,211,110,.4); }
  }
  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }
  @keyframes sparkle {
    0%, 100% { opacity: 0; transform: scale(0); }
    50% { opacity: 1; transform: scale(1); }
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes celebrate {
    0% { transform: scale(0) rotate(0deg); opacity: 0; }
    50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
    100% { transform: scale(1) rotate(360deg); opacity: 1; }
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  
  /* William Character Animations - 15 different actions */
  @keyframes william-jump {
    0%, 100% { transform: translateY(0) scale(1); }
    30% { transform: translateY(-30px) scale(1.05); }
    60% { transform: translateY(-20px) scale(1.02); }
  }
  @keyframes william-spin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
  }
  @keyframes william-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px) rotate(-5deg); }
    75% { transform: translateX(10px) rotate(5deg); }
  }
  @keyframes william-flip {
    0% { transform: rotateY(0deg); }
    50% { transform: rotateY(180deg) scale(1.1); }
    100% { transform: rotateY(360deg); }
  }
  @keyframes william-wave {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-15deg); }
    75% { transform: rotate(15deg); }
  }
  @keyframes william-pulse-glow {
    0%, 100% { transform: scale(1); filter: brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
    50% { transform: scale(1.15); filter: brightness(1.3) drop-shadow(0 8px 16px rgba(255,211,110,0.6)); }
  }
  @keyframes william-bounce-rotate {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-20px) rotate(-10deg); }
    50% { transform: translateY(0) rotate(0deg); }
    75% { transform: translateY(-15px) rotate(10deg); }
  }
  @keyframes william-swing {
    0%, 100% { transform: rotate(0deg) translateX(0); }
    25% { transform: rotate(20deg) translateX(10px); }
    75% { transform: rotate(-20deg) translateX(-10px); }
  }
  @keyframes william-zoom {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
  }
  @keyframes william-slide {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(30px); }
  }
  @keyframes william-wobble {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(10deg) scale(1.05); }
    50% { transform: rotate(-10deg) scale(1.1); }
    75% { transform: rotate(5deg) scale(1.05); }
  }
  @keyframes william-float-spin {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-25px) rotate(360deg); }
  }
  @keyframes william-bounce-scale {
    0%, 100% { transform: scale(1) translateY(0); }
    50% { transform: scale(0.8) translateY(-25px); }
  }
  @keyframes william-rainbow {
    0% { filter: hue-rotate(0deg) brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
    25% { filter: hue-rotate(90deg) brightness(1.2) drop-shadow(0 8px 16px rgba(255,0,255,0.5)); }
    50% { filter: hue-rotate(180deg) brightness(1.3) drop-shadow(0 8px 16px rgba(0,255,255,0.5)); }
    75% { filter: hue-rotate(270deg) brightness(1.2) drop-shadow(0 8px 16px rgba(255,255,0,0.5)); }
    100% { filter: hue-rotate(360deg) brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
  }
  @keyframes william-victory {
    0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
    20% { transform: translateY(-15px) scale(1.1) rotate(-5deg); }
    40% { transform: translateY(-10px) scale(1.15) rotate(5deg); }
    60% { transform: translateY(-20px) scale(1.1) rotate(-3deg); }
    80% { transform: translateY(-5px) scale(1.05) rotate(3deg); }
  }
  
  /* Fun Animations for Kids! */
  @keyframes william-fire {
    0% { transform: scale(1); filter: brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
    20% { transform: scale(1.1) rotate(-10deg); filter: brightness(1.3) drop-shadow(0 0 20px rgba(255,100,0,0.8)); }
    40% { transform: scale(1.15) rotate(5deg); filter: brightness(1.5) drop-shadow(0 0 30px rgba(255,50,0,0.9)); }
    60% { transform: scale(1.1) rotate(-5deg); filter: brightness(1.4) drop-shadow(0 0 25px rgba(255,80,0,0.8)); }
    80% { transform: scale(1.05); filter: brightness(1.2) drop-shadow(0 0 15px rgba(255,120,0,0.6)); }
    100% { transform: scale(1); filter: brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
  }
  @keyframes william-fart {
    0%, 100% { transform: translateX(0) translateY(0) rotate(0deg); }
    10% { transform: translateX(-5px) translateY(3px) rotate(-2deg); }
    20% { transform: translateX(8px) translateY(-2px) rotate(3deg); }
    30% { transform: translateX(-6px) translateY(2px) rotate(-3deg); }
    40% { transform: translateX(7px) translateY(-3px) rotate(2deg); }
    50% { transform: translateX(-8px) translateY(4px) rotate(-2deg); }
    60% { transform: translateX(6px) translateY(-2px) rotate(3deg); }
    70% { transform: translateX(-4px) translateY(2px) rotate(-1deg); }
    80% { transform: translateX(3px) translateY(-1px) rotate(1deg); }
  }
  @keyframes william-throw {
    0% { transform: rotate(0deg) translateX(0); }
    30% { transform: rotate(-30deg) translateX(-15px); }
    50% { transform: rotate(20deg) translateX(10px) scale(1.1); }
    70% { transform: rotate(5deg) translateX(5px); }
    100% { transform: rotate(0deg) translateX(0); }
  }
  @keyframes william-burp {
    0%, 100% { transform: scale(1); }
    20% { transform: scale(1.15, 0.9); }
    40% { transform: scale(0.95, 1.1); }
    60% { transform: scale(1.1, 0.95); }
    80% { transform: scale(0.98, 1.05); }
  }
  @keyframes william-sneeze {
    0%, 100% { transform: translateY(0) scale(1); }
    10% { transform: translateY(-5px) scale(1.05, 0.95); }
    30% { transform: translateY(-10px) scale(1.1, 0.9); }
    50% { transform: translateY(8px) scale(0.9, 1.15); }
    70% { transform: translateY(-3px) scale(1.05, 0.98); }
  }
  @keyframes william-dizzy {
    0% { transform: rotate(0deg); filter: blur(0px); }
    25% { transform: rotate(90deg); filter: blur(2px); }
    50% { transform: rotate(180deg); filter: blur(3px); }
    75% { transform: rotate(270deg); filter: blur(2px); }
    100% { transform: rotate(360deg); filter: blur(0px); }
  }
  @keyframes william-dance {
    0%, 100% { transform: rotate(0deg) translateX(0) scale(1); }
    15% { transform: rotate(-15deg) translateX(-10px) scale(1.05); }
    30% { transform: rotate(15deg) translateX(10px) scale(1.1); }
    45% { transform: rotate(-10deg) translateX(-8px) scale(1.05); }
    60% { transform: rotate(10deg) translateX(8px) scale(1.08); }
    75% { transform: rotate(-5deg) translateX(-5px) scale(1.03); }
  }
  @keyframes william-explode {
    0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
    30% { transform: scale(0.8) rotate(-20deg); filter: brightness(1.2); }
    50% { transform: scale(1.5) rotate(180deg); filter: brightness(2); }
    70% { transform: scale(1.3) rotate(270deg); filter: brightness(1.5); }
    100% { transform: scale(1) rotate(360deg); filter: brightness(1); }
  }
  @keyframes william-water-balloon {
    0% { transform: rotate(0deg) translateX(0) scale(1); }
    20% { transform: rotate(-45deg) translateX(-20px) scale(1.1); }
    50% { transform: rotate(20deg) translateX(10px) scale(1.05); }
    100% { transform: rotate(0deg) translateX(0) scale(1); }
  }
  @keyframes william-slip-out {
    0% { transform: translateX(0) translateY(0) rotate(0deg); }
    20% { transform: translateX(50px) translateY(-30px) rotate(15deg) scale(0.95); }
    40% { transform: translateX(100px) translateY(-20px) rotate(-10deg) scale(0.9); }
    60% { transform: translateX(150px) translateY(-40px) rotate(20deg) scale(0.95); }
    80% { transform: translateX(100px) translateY(-20px) rotate(-5deg) scale(0.95); }
    100% { transform: translateX(0) translateY(0) rotate(0deg) scale(1); }
  }
  
  /* Easter Egg Emotes (Click-Triggered) - 15 Animations */
  @keyframes easter-confetti-sneezus {
    0% { transform: scale(1); }
    20% { transform: scale(0.95, 1.05); } /* Scrunch face */
    40% { transform: scale(1.15, 0.9); } /* Big sneeze prep */
    50% { transform: scale(0.9, 1.1); } /* Sneeze! */
    70% { transform: scale(1.05, 0.98) rotate(-5deg); } /* Recoil */
    85% { transform: scale(1.02) rotate(2deg); } /* Blink confused */
    100% { transform: scale(1) rotate(0deg); }
  }
  @keyframes easter-banana-slip {
    0% { transform: translateX(0) translateY(0) rotate(0deg); }
    15% { transform: translateX(10px) translateY(-5px) rotate(-10deg); } /* Slip */
    30% { transform: translateX(20px) translateY(-15px) rotate(90deg) scale(0.95); } /* Flail */
    50% { transform: translateX(30px) translateY(-20px) rotate(180deg) scale(0.9); } /* Spin */
    70% { transform: translateX(20px) translateY(-5px) rotate(270deg) scale(0.95); } /* More spin */
    85% { transform: translateX(0) translateY(0) rotate(360deg) scale(1.05); } /* Landing */
    100% { transform: translateX(0) translateY(0) rotate(360deg) scale(1); } /* Seated + thumbs up */
  }
  @keyframes easter-bubble-burp {
    0% { transform: scale(1); }
    20% { transform: scale(1.1, 0.95); } /* Tiny burp prep */
    40% { transform: scale(0.95, 1.05); } /* Burp */
    60% { transform: scale(1.02, 0.98); }
    100% { transform: scale(1); }
  }
  @keyframes easter-pie-trap {
    0% { transform: translateX(0) rotate(0deg); }
    15% { transform: translateX(5px) rotate(5deg); } /* Trip */
    30% { transform: translateX(-5px) rotate(-5deg) scale(1.05); } /* Stumble */
    50% { transform: scale(0.95, 1.1) rotate(0deg); } /* Pie splat! */
    70% { transform: scale(1.05, 0.95); } /* Recoil */
    85% { transform: scale(1.02) rotate(-3deg); } /* Wipe face */
    100% { transform: scale(1) rotate(0deg); } /* "Really?" */
  }
  @keyframes easter-rubber-chicken {
    0% { transform: rotate(0deg) scale(1); }
    20% { transform: rotate(-15deg) scale(1.05); } /* Opens backpack */
    40% { transform: rotate(10deg) scale(1.1); } /* Chicken appears */
    60% { transform: rotate(-10deg) scale(1.08); } /* Squeeze */
    80% { transform: rotate(5deg) scale(1.03); } /* Poof prep */
    100% { transform: rotate(0deg) scale(1); } /* Away */
  }
  @keyframes easter-hero-landing {
    0% { transform: translateY(0) scale(1); }
    30% { transform: translateY(-15px) scale(1.05); } /* Tiny hop */
    60% { transform: translateY(0) scale(1.1, 0.9) rotate(-3deg); } /* Dramatic landing */
    80% { transform: scale(1.05) rotate(2deg); } /* Impact */
    100% { transform: scale(1) rotate(0deg); } /* Shrug */
  }
  @keyframes easter-endless-scarf {
    0% { transform: translateX(0) scale(1); }
    30% { transform: translateX(-10px) scale(1.05) rotate(-5deg); } /* Pull scarf */
    60% { transform: translateX(-15px) scale(1.08) rotate(-8deg); } /* More scarf */
    80% { transform: translateX(-8px) scale(1.03) rotate(-3deg); } /* Piles up */
    90% { transform: translateX(5px) scale(0.98) rotate(5deg); } /* Light trip */
    100% { transform: translateX(0) scale(1) rotate(0deg); }
  }
  @keyframes easter-frog-crown {
    0% { transform: scale(1) rotate(0deg); }
    20% { transform: scale(1.05) rotate(-10deg); } /* Cast gesture */
    40% { transform: scale(1.1) rotate(10deg); } /* Frog pops on head */
    60% { transform: scale(1.08) rotate(-5deg); }
    80% { transform: scale(1.03) rotate(3deg); } /* Ribbit */
    100% { transform: scale(1) rotate(0deg); } /* Smile */
  }
  @keyframes easter-chipmunk-voice {
    0% { transform: scale(1); }
    20% { transform: scale(1.05, 0.98) rotate(-5deg); } /* Drinks potion */
    40% { transform: scale(0.95, 1.1) rotate(5deg); } /* Musical notes */
    60% { transform: scale(1.08, 0.95) rotate(-3deg); } /* Squeaky talking */
    80% { transform: scale(0.98, 1.05) rotate(3deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  @keyframes easter-marshmallow-volley {
    0% { transform: rotate(0deg) scale(1); }
    20% { transform: rotate(-20deg) scale(1.05); } /* Fires */
    40% { transform: rotate(10deg) scale(1.08); } /* Rebound */
    60% { transform: scale(1.1, 0.95) rotate(0deg); } /* Bonk forehead */
    80% { transform: scale(0.95, 1.05) rotate(-5deg); } /* Wobble */
    100% { transform: scale(1) rotate(0deg); }
  }
  @keyframes easter-hair-tornado {
    0% { transform: rotate(0deg) scale(1); }
    20% { transform: rotate(180deg) scale(1.1); } /* Mini whirlwind */
    40% { transform: rotate(360deg) scale(1.15); } /* Spins */
    60% { transform: rotate(540deg) scale(1.1); } /* Wild hair */
    80% { transform: rotate(720deg) scale(1.05); } /* Tries to fix */
    100% { transform: rotate(720deg) scale(1); } /* Shocked */
  }
  @keyframes easter-tiger-shuffle {
    0%, 100% { transform: translateX(0) rotate(0deg) scale(1); }
    15% { transform: translateX(-15px) rotate(-10deg) scale(1.05); } /* Dance left */
    30% { transform: translateX(15px) rotate(10deg) scale(1.08); } /* Dance right */
    45% { transform: translateX(-12px) rotate(-8deg) scale(1.05); }
    60% { transform: translateX(12px) rotate(8deg) scale(1.08); }
    75% { transform: translateX(-8px) rotate(-5deg) scale(1.03); }
    90% { transform: translateX(0) rotate(0deg) scale(1.05); }
  }
  @keyframes easter-lego-step {
    0% { transform: translateY(0) scale(1); }
    20% { transform: translateY(-10px) scale(1.05, 0.98); } /* "Ouch" face */
    40% { transform: translateY(-25px) scale(1.08, 0.95) rotate(-10deg); } /* One-foot hop */
    60% { transform: translateY(-15px) scale(1.05, 0.98) rotate(5deg); }
    80% { transform: translateY(-5px) scale(1.02) rotate(-3deg); } /* Shakes foot */
    100% { transform: translateY(0) scale(1) rotate(0deg); } /* Points at ground */
  }
  @keyframes easter-goose-chase {
    0%, 100% { transform: translateX(0) rotate(0deg) scale(1); }
    20% { transform: translateX(20px) rotate(10deg) scale(1.05); } /* Goose honks */
    40% { transform: translateX(40px) rotate(-10deg) scale(1.08); } /* Chase */
    60% { transform: translateX(20px) rotate(5deg) scale(1.05); } /* More chase */
    80% { transform: translateX(-10px) rotate(-5deg) scale(1.02); } /* Feather gift */
    95% { transform: translateX(0) rotate(0deg) scale(1.05); } /* Friends */
  }
  @keyframes easter-sock-chest {
    0% { transform: scale(1) rotate(0deg); }
    15% { transform: scale(1.05) rotate(-5deg); } /* Opens chest */
    30% { transform: scale(1.1, 0.95) rotate(5deg); } /* Excited */
    50% { transform: scale(0.95, 1.1) rotate(-10deg); } /* Socks explode out */
    70% { transform: scale(1.05, 0.98) rotate(5deg); } /* Offended face */
    90% { transform: scale(1.02) rotate(-3deg); } /* Slow facepalm */
    100% { transform: scale(1) rotate(0deg); }
  }
  
  /* Easter Egg Rest State */
  @keyframes easter-rest-state {
    0%, 100% { transform: translateY(10px) rotate(-90deg) scale(1); } /* Laying down */
    50% { transform: translateY(12px) rotate(-90deg) scale(1.02); } /* Breathing */
  }
  
  /* Particle effect animations */
  @keyframes fireParticle {
    0% { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
    100% { transform: translateX(100px) translateY(-50px) scale(0.5); opacity: 0; }
  }
  @keyframes fartParticle {
    0% { transform: translateX(0) translateY(0) scale(0.5); opacity: 1; }
    100% { transform: translateX(-80px) translateY(-60px) scale(2); opacity: 0; }
  }
  @keyframes throwParticle {
    0% { transform: translateX(0) translateY(0) rotate(0deg) scale(1); opacity: 1; }
    100% { transform: translateX(200px) translateY(-80px) rotate(720deg) scale(0.8); opacity: 0; }
  }
  @keyframes waterBalloonParticle {
    0% { transform: translateX(0) translateY(0) rotate(0deg) scale(1); opacity: 1; }
    70% { transform: translateX(180px) translateY(-60px) rotate(360deg) scale(1.1); opacity: 1; }
    85% { transform: translateX(200px) translateY(-50px) rotate(400deg) scale(1.3); opacity: 0.8; }
    100% { transform: translateX(220px) translateY(-40px) rotate(450deg) scale(0); opacity: 0; }
  }
  @keyframes waterSplash {
    0% { transform: scale(0) rotate(0deg); opacity: 1; }
    50% { transform: scale(1.5) rotate(180deg); opacity: 0.8; }
    100% { transform: scale(2) rotate(360deg); opacity: 0; }
  }
  @keyframes burpParticle {
    0% { transform: translateY(0) scale(0.8); opacity: 1; }
    100% { transform: translateY(-60px) scale(1.5); opacity: 0; }
  }
  @keyframes sneezeParticle {
    0% { transform: translateX(0) translateY(0) scale(1); opacity: 1; }
    100% { transform: translateX(80px) translateY(-50px) scale(0.3); opacity: 0; }
  }
  @keyframes explodeParticle {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(150px, -50px) scale(0.5); opacity: 0; }
  }
  
  body {
    margin: 0;
    padding: 0;
    background: 
      linear-gradient(180deg, rgba(26,10,46,.2) 0%, rgba(61,36,72,.15) 20%, rgba(139,74,63,.1) 40%, rgba(212,118,42,.1) 60%, rgba(61,36,72,.15) 80%, rgba(26,10,46,.2) 100%),
      url("./assets/images/ChatGPT%20Image%20Feb%208,%202026,%2012_39_11%20AM.png") center/cover no-repeat fixed;
    background-color: #0a0612;
    position: relative;
    overflow-x: hidden;
    min-height: 100vh;
  }
  
  /* Starfield background */
  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
      radial-gradient(2px 2px at 20% 30%, #ffd36e, transparent),
      radial-gradient(2px 2px at 60% 70%, #ffd36e, transparent),
      radial-gradient(1px 1px at 50% 50%, #fff5e6, transparent),
      radial-gradient(1px 1px at 80% 10%, #ffd36e, transparent),
      radial-gradient(2px 2px at 90% 60%, #fff5e6, transparent),
      radial-gradient(1px 1px at 33% 80%, #ffd36e, transparent),
      radial-gradient(2px 2px at 75% 40%, #fff5e6, transparent);
    background-size: 200% 200%;
    animation: starfield 8s ease-in-out infinite;
    opacity: .15;
    pointer-events: none;
    z-index: 1;
  }
  #ww{font-family:var(--font); color:var(--ink); position: relative; z-index: 10;}
  #ww *{box-sizing:border-box}
  #ww .wrap{max-width:var(--max); margin:0 auto; padding:14px}
  #ww .topbar{
    position:sticky; top:0; z-index:60;
    background: var(--glass-strong-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border:2px solid var(--golden-border);
    border-radius:18px;
    padding:10px 12px;
    box-shadow: 0 0 15px rgba(212,165,48,.3);
  }
  #ww .topbar-inner{display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap}
  #ww .brand{display:flex; gap:10px; align-items:center; font-weight:950}
  #ww .logoMark{width:34px; height:34px; border-radius:12px; border:2px solid var(--golden-border); overflow:hidden}
  #ww .logoMark img{width:100%;height:100%;object-fit:cover;display:block}
  #ww .badge{font-size:12px; padding:4px 9px; border:2px solid var(--golden-border); color:var(--gold); border-radius:999px; background: rgba(255,211,110,.15); font-weight:800}
  #ww .nav{display:flex; gap:8px; flex-wrap:wrap}
  #ww .nav button{
    border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); color:var(--ink);
    padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:850; font-size:13px;
  }
  #ww .nav button.active{background: rgba(255,211,110,.25); border-color: var(--gold); box-shadow: 0 0 10px rgba(255,211,110,.4)}
  #ww .banner{
    margin-top:12px; border-radius:26px; border:3px solid var(--gold);
    box-shadow:var(--shadow), 0 0 30px rgba(240,168,48,.4); overflow:hidden; position:relative;
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    min-height: 420px;
  }
  #ww .banner-inner{padding:18px; display:grid; grid-template-columns: 250px 1fr; gap:20px; align-items:center}
  #ww .banner-inner > .card{grid-column: 1 / -1}
  @media (max-width:980px){ #ww .banner-inner{grid-template-columns:1fr; justify-items:center} }
  #ww h1{margin:0 0 6px; font-size:48px; font-weight:900; color:var(--gold); 
    font-family: var(--fantasy-font);
    text-shadow: 
      3px 3px 0 rgba(0,0,0,.9), 
      -2px -2px 0 rgba(0,0,0,.9), 
      2px -2px 0 rgba(0,0,0,.9), 
      -2px 2px 0 rgba(0,0,0,.9),
      0 0 20px rgba(240,168,48,.7),
      0 0 40px rgba(240,168,48,.5);
    animation: float 3s ease-in-out infinite;
  }
  #ww .levelTitle {
    font-family: var(--fantasy-font);
    font-size: 20px;
    color: var(--gold);
    text-shadow: 2px 2px 4px rgba(0,0,0,.8);
    margin-top: 8px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  #ww .william-avatar {
    width: 280px;
    height: 280px;
    border-radius: 0;
    border: none;
    overflow: visible;
    box-shadow: none;
    flex-shrink: 0;
    background: transparent;
    padding: 0;
    position: relative;
    z-index: 100;
    transition: transform 0.5s ease, filter 0.5s ease, left 0.5s ease, top 0.5s ease;
    pointer-events: auto;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    margin: 10px;
  }
  #ww .william-avatar:hover {
    filter: drop-shadow(0 0 15px rgba(255,211,110,0.6));
  }
  #ww .william-avatar.clickable-glow {
    animation: glow 2s ease-in-out infinite;
  }
  #ww .william-avatar img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  }
  #ww p{margin:0; color:var(--muted); font-weight:650; text-shadow: 1px 1px 2px rgba(0,0,0,.7)}
  #ww .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  #ww .btn{
    border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); color:var(--ink);
    padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:950; font-size:14px;
    transition: all .3s ease;
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1), 0 0 10px rgba(240,168,48,.2);
  }
  #ww .btn:hover{
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.2), 0 0 20px rgba(255,211,110,.4);
  }
  #ww .btn:active{
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,.3), inset 0 1px 0 rgba(0,0,0,.1);
  }
  #ww .btn.primary{
    background: var(--glass-bg); 
    border-color: var(--golden-border);
  }
  #ww .btn.gold{
    background: var(--glass-bg); 
    border-color: var(--gold);
  }
  #ww .btn.danger{
    background: var(--glass-bg); 
    border-color: rgba(255,107,138,.6);
  }
  #ww .statRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  #ww .pill{border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:999px; padding:8px 10px; display:flex; gap:8px; align-items:center; font-weight:900; font-size:13px; text-shadow: 1px 1px 2px rgba(0,0,0,.7)}
  #ww .dot{width:10px;height:10px;border-radius:999px;background:var(--golden-border)}
  #ww .dot.green{background:var(--green)}
  #ww .dot.gold{background:var(--gold)}
  #ww .meter{border:2px solid var(--golden-border); border-radius:14px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); padding:10px; margin-top:10px}
  #ww .meterTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:8px}
  #ww .small{font-size:12px; color:var(--muted); font-weight:650; text-shadow: 1px 1px 2px rgba(0,0,0,.7)}
  #ww .bar{height:16px;border-radius:999px;background: rgba(50,30,20,.65);overflow:hidden;border:2px solid var(--golden-border); position: relative;}
  #ww .bar > div{
    height:100%; width:0%; 
    background: linear-gradient(90deg, 
      rgba(255,211,110,.95), 
      rgba(255,170,50,.95), 
      rgba(255,211,110,.95)
    ); 
    background-size: 200% 100%;
    animation: shimmer 2s linear infinite;
    transition: width .5s ease;
    box-shadow: 0 0 10px rgba(255,211,110,.5), inset 0 1px 0 rgba(255,255,255,.3);
    position: relative;
  }
  #ww .bar > div::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
    animation: shimmer 1.5s linear infinite;
  }
  #ww .grid{margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media (max-width:980px){ #ww .grid{grid-template-columns:1fr} }
  #ww .card{border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:var(--r1); box-shadow:var(--shadow), 0 0 15px rgba(255,211,110,.2); padding:var(--pad)}
  #ww .banner .card{background: var(--glass-strong-bg)}
  #ww .card h2{margin:0 0 10px; font-size:15px; display:flex; justify-content:space-between; align-items:center; gap:10px; text-shadow: 1px 1px 3px rgba(0,0,0,.8)}
  #ww .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); color:var(--gold); font-weight:900}
  #ww .frame{border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:var(--r2); padding:12px}
  #ww .taskList{display:grid; gap:10px; margin-top:10px}
  #ww .task{display:grid; grid-template-columns:28px 1fr auto; gap:10px; align-items:center; border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:16px; padding:10px}
  #ww .task input{width:20px;height:20px; accent-color: var(--green)}
  #ww .task .name{font-weight:950}
  #ww .task .xp{font-weight:1000; padding:6px 9px; border-radius:999px; border:2px solid rgba(255,211,110,.55); background: rgba(255,211,110,.15); font-size:12px; min-width:74px; text-align:center; color:var(--gold)}
  #ww .party{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px}
  @media (max-width:520px){ #ww .party{grid-template-columns:1fr} }
  #ww .creature{border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:16px; padding:10px; display:flex; gap:10px; align-items:center}
  #ww .avatar{width:42px;height:42px;border-radius:16px;border:2px solid var(--golden-border);overflow:hidden}
  #ww .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  #ww .map{display:grid; gap:10px; margin-top:10px}
  #ww .node{border:2px solid var(--golden-border); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:16px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  #ww .node .left{display:flex; gap:10px; align-items:center}
  #ww .node .icon{width:36px;height:36px;border-radius:14px;border:2px solid var(--golden-border); overflow:hidden}
  #ww .node .icon img{width:100%;height:100%;object-fit:cover;display:block}
  #ww .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%); 
    background: var(--glass-strong-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border:2px solid var(--golden-border); 
    padding:16px 24px; border-radius:16px; 
    box-shadow:var(--shadow), 0 0 30px rgba(255,211,110,.5); 
    display:none; z-index:999; 
    font-weight:900; font-size:16px;
    animation: slideUp .3s ease-out;
    min-width: 200px;
    text-align: center;
    text-shadow: 1px 1px 3px rgba(0,0,0,.8);
  }
  
  /* Floating XP animation */
  @keyframes floatXP {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
  }
  .floatingXP {
    position: fixed;
    font-weight: 900;
    font-size: 24px;
    color: var(--green);
    text-shadow: 2px 2px 4px rgba(0,0,0,.8), 0 0 10px var(--green);
    pointer-events: none;
    z-index: 1000;
    animation: floatXP 1.5s ease-out forwards;
  }
  
  /* Level-Up Celebration Overlay */
  #levelUpOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn .3s ease-out;
  }
  #levelUpOverlay.show {
    display: flex;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  #levelUpOverlay .content {
    text-align: center;
    animation: celebrate .6s ease-out;
  }
  #levelUpOverlay .content h2 {
    font-size: 72px;
    font-family: var(--fantasy-font);
    color: var(--gold);
    text-shadow: 
      4px 4px 0 rgba(0,0,0,.9),
      0 0 30px rgba(240,168,48,.9),
      0 0 60px rgba(240,168,48,.6);
    margin: 0 0 20px;
    animation: pulse 1s ease-in-out infinite;
  }
  #levelUpOverlay .levelInfo {
    font-size: 32px;
    font-family: var(--fantasy-font);
    color: var(--ink);
    margin-bottom: 10px;
  }
  #levelUpOverlay .levelTitle {
    font-size: 28px;
    color: var(--gold);
  }
  #levelUpOverlay .william-avatar-overlay {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 5px solid var(--gold);
    overflow: hidden;
    box-shadow: 0 0 30px rgba(255,211,110,.6), 0 0 60px rgba(255,211,110,.3);
    margin: 0 auto 20px;
    animation: pulse 2s ease-in-out infinite;
  }
  #levelUpOverlay .william-avatar-overlay img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  @keyframes particles {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-100px) scale(0); opacity: 0; }
  }
  .particle {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--gold);
    border-radius: 50%;
    animation: particles 2s ease-out forwards;
    pointer-events: none;
  }
  
  /* William Rest State Overlay */
  #williamRestOverlay {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--glass-strong-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 3px solid var(--golden-border);
    border-radius: var(--r1);
    padding: 24px;
    display: none;
    z-index: 10001;
    text-align: center;
    box-shadow: var(--shadow), 0 0 30px rgba(255,211,110,.4);
    animation: slideUp .3s ease-out;
    max-width: 90%;
    width: 400px;
  }
  #williamRestOverlay.show {
    display: block;
  }
  #williamRestOverlay .message {
    font-size: 20px;
    font-weight: 900;
    color: var(--ink);
    text-shadow: 2px 2px 4px rgba(0,0,0,.8);
    margin-bottom: 12px;
  }
  #williamRestOverlay .countdown {
    font-size: 16px;
    color: var(--muted);
    font-weight: 650;
  }
  #williamRestOverlay .zzz {
    font-size: 32px;
    animation: float 2s ease-in-out infinite;
    margin-top: 10px;
  }
  
  /* Companion Party Styles */
  #ww .companion {
    border: 3px solid var(--line);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 18px;
    padding: 16px;
    transition: all .3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,.3), 0 0 10px rgba(240,168,48,.2);
  }
  #ww .companion:hover {
    transform: translateY(-4px);
    border-color: var(--gold);
    box-shadow: 0 8px 20px rgba(0,0,0,.5), 0 0 20px rgba(240,168,48,.4);
  }
  #ww .companion .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }
  #ww .companion .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid var(--gold);
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,.5);
  }
  #ww .companion .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  #ww .companion .info {
    flex: 1;
  }
  #ww .companion .name {
    font-size: 18px;
    font-weight: 900;
    color: var(--gold);
    font-family: var(--fantasy-font);
  }
  #ww .companion .type {
    font-size: 13px;
    color: var(--muted);
    font-weight: 700;
  }
  #ww .companion .level {
    font-size: 14px;
    font-weight: 900;
    color: var(--green);
    margin-top: 4px;
  }
  #ww .companion .statBar {
    margin-top: 8px;
  }
  #ww .companion .statLabel {
    font-size: 11px;
    color: var(--muted);
    font-weight: 700;
    margin-bottom: 4px;
  }
  #ww .companion .bar {
    height: 8px;
  }
  #ww .companion.evolved {
    border-color: var(--gold);
    box-shadow: 0 0 25px rgba(240,168,48,.5), 0 4px 12px rgba(0,0,0,.3);
  }
  
  /* World Map Zone Styles */
  #ww .zone {
    border: 3px solid var(--golden-border);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 18px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all .3s ease;
    position: relative;
    overflow: hidden;
  }
  #ww .zone::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,.03), transparent);
    transform: translateX(-100%);
    transition: transform .6s ease;
  }
  #ww .zone:hover::before {
    transform: translateX(100%);
  }
  #ww .zone .zoneIcon {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    border: 3px solid var(--golden-border);
    overflow: hidden;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,.5);
  }
  #ww .zone .zoneIcon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  #ww .zone .zoneInfo {
    flex: 1;
  }
  #ww .zone .zoneName {
    font-size: 18px;
    font-weight: 900;
    color: var(--gold);
    font-family: var(--fantasy-font);
    margin-bottom: 6px;
  }
  #ww .zone .zoneStatus {
    font-size: 13px;
    font-weight: 800;
    padding: 4px 12px;
    border-radius: 999px;
    display: inline-block;
  }
  #ww .zone .zoneStatus.locked {
    background: rgba(255,107,138,.15);
    border: 2px solid rgba(255,107,138,.4);
    color: rgba(255,107,138,.9);
  }
  #ww .zone .zoneStatus.unlocked {
    background: rgba(125,255,180,.15);
    border: 2px solid var(--green);
    color: var(--green);
  }
  #ww .zone.locked {
    opacity: .5;
    filter: grayscale(80%);
  }
  #ww .zone.unlocked {
    border-color: var(--green);
    box-shadow: 0 0 25px rgba(125,255,180,.3), 0 4px 12px rgba(0,0,0,.3);
  }
  #ww .zone.unlocked:hover {
    transform: translateY(-4px);
    box-shadow: 0 0 35px rgba(125,255,180,.5), 0 8px 20px rgba(0,0,0,.5);
  }
  #ww .lockIcon {
    font-size: 32px;
    opacity: .5;
  }
  
  /* HP Bar Styles */
  #ww .hpMeter { margin-top: 8px; }
  #ww .hpMeter .bar { background: #1a0a0a; }
  #ww .hpMeter .bar > div { background: linear-gradient(90deg, #dc2626, #ff4444); transition: width .4s ease; }
  #ww .hpMeter.low .bar > div { background: linear-gradient(90deg, #991b1b, #dc2626); animation: pulse 1s ease-in-out infinite; }
  #ww .hpPill .dot { background: var(--red); }
  
  /* Quest Map Sidebar Styles */
  #ww .questMapSidebar {
    border: 2px solid var(--golden-border);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 18px;
    padding: 16px;
    box-shadow: var(--shadow), 0 0 15px rgba(255,211,110,.2);
  }
  
  #ww .questMapSidebar h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 900;
    color: var(--gold);
    font-family: var(--fantasy-font);
  }
  
  #ww .zoneIconList {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  #ww .zoneIconItem {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    border: 2px solid var(--golden-border);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 12px;
    transition: all .3s ease;
    cursor: pointer;
  }
  
  #ww .zoneIconItem:hover {
    transform: translateX(4px);
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(255,211,110,.3);
  }
  
  #ww .zoneIconItem.unlocked {
    border-color: var(--green);
    box-shadow: 0 0 15px rgba(125,255,180,.2);
  }
  
  #ww .zoneIconItem.unlocked:hover {
    box-shadow: 0 0 20px rgba(125,255,180,.4);
  }
  
  #ww .zoneIconItem.locked {
    opacity: .6;
    filter: grayscale(60%);
  }
  
  #ww .zoneIconItem .zoneIconSmall {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    border: 2px solid var(--golden-border);
    overflow: hidden;
    flex-shrink: 0;
  }
  
  #ww .zoneIconItem .zoneIconSmall img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  #ww .zoneIconItem .zoneIconInfo {
    flex: 1;
    min-width: 0;
  }
  
  #ww .zoneIconItem .zoneIconName {
    font-size: 14px;
    font-weight: 900;
    color: var(--gold);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  #ww .zoneIconItem .zoneIconStatus {
    font-size: 11px;
    font-weight: 700;
    opacity: .8;
  }
  
  #ww .zoneIconItem.unlocked .zoneIconStatus {
    color: var(--green);
  }
  
  #ww .zoneIconItem.locked .zoneIconStatus {
    color: rgba(255,107,138,.9);
  }
  
  #ww .currentQuestHeader {
    border: 2px solid var(--golden-border);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: 18px;
    padding: 16px;
    box-shadow: var(--shadow), 0 0 15px rgba(255,211,110,.2);
  }
  
  #ww .currentQuestHeader h2 {
    margin: 0 0 8px 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Streak Fire Icon Enhancement */
  .streakFire {
    display: inline-block;
    animation: pulse 1.5s ease-in-out infinite;
  }
  .streakFire.mega {
    font-size: 28px;
    filter: drop-shadow(0 0 10px rgba(255,140,70,.8));
  }
  
  /* Main Content + Sidebar Layout */
  /* Main Content + Sidebar Layout - Desktop optimized */
  #ww .contentWithSidebar {
    display: block;
    margin-top: 20px;
  }
  
  #ww .mainContent {
    flex: 1;
    min-width: 0;
  }
  
  /* Desktop-optimized: quest cards in horizontal grid */
  #ww .questSidebar {
    width: 100%;
    position: relative;
    top: 0;
    display: block;
  }
  
  /* Current Quest Header */
  #ww .currentQuestHeader {
    margin-bottom: 20px;
  }
  
  /* Quest Map Sidebar - Desktop: compact horizontal layout */
  #ww .questMapSidebar {
    margin-bottom: 24px;
  }
  
  /* Quest Grid - Horizontal on Desktop */
  #ww .questGrid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
  
  /* Tablet: 2 column layout */
  @media (max-width: 1400px) {
    #ww .questGrid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  /* Mobile: single column, vertical stacking */
  @media (max-width: 900px) {
    #ww .contentWithSidebar {
      flex-direction: column;
    }
    #ww .questGrid {
      grid-template-columns: 1fr;
    }
  }
  
  #ww .questCard{
    border:4px solid var(--gold); 
    background: var(--glass-bg); 
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius:24px; 
    box-shadow:var(--shadow), 0 0 30px rgba(255,211,110,.5), inset 0 2px 0 rgba(255,255,255,.1); 
    padding:24px; 
    position:relative;
    overflow:hidden; 
    min-height:400px; 
    display:flex; 
    flex-direction:column;
    transition: all .3s ease;
  }
  #ww .questCard:hover {
    transform: translateY(-4px);
    box-shadow:var(--shadow), 0 0 40px rgba(255,211,110,.7), inset 0 2px 0 rgba(255,255,255,.2);
    border-color: rgba(255,211,110,1);
  }
  #ww .questCard::before{
    content:""; position:absolute; top:0; left:0; right:0; bottom:0; 
    background-size:cover; background-position:center; opacity:.2; z-index:0;
  }
  #ww .questCard::after {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,.03), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s linear infinite;
  }
  #ww .questCard > *{position:relative; z-index:1}
  
  #ww .questCard.night,
  #ww .questCard.morning,
  #ww .questCard.backpack{
    background: var(--glass-bg);
    border-color: var(--gold);
  }
  
  #ww .questIcon{
    width:70px; height:70px; border-radius:50%; border:4px solid var(--gold);
    background: linear-gradient(135deg, rgba(0,0,0,.6), rgba(0,0,0,.4)); 
    display:flex; align-items:center; justify-content:center;
    font-size:36px; margin-bottom:14px; 
    box-shadow:0 6px 16px rgba(0,0,0,.6), inset 0 2px 0 rgba(255,255,255,.2);
    animation: bounce 2s ease-in-out infinite;
  }
  
  #ww .questCard h3{
    margin:0 0 12px; font-size:26px; font-weight:900; color:var(--gold);
    font-family: var(--fantasy-font);
    text-shadow: 
      3px 3px 0 rgba(0,0,0,.9), 
      -1px -1px 0 rgba(0,0,0,.9),
      0 0 15px rgba(240,168,48,.6);
    letter-spacing: 1px;
  }
  
  #ww .questChecklist{margin:16px 0; flex:1}
  #ww .questChecklist .checkItem{
    display:flex; align-items:center; gap:12px; padding:10px 12px; 
    font-weight:700; font-size:15px;
    background: rgba(0,0,0,.25);
    border-radius: 12px;
    margin-bottom: 10px;
    border: 2px solid rgba(255,255,255,.1);
    transition: all .3s ease;
    cursor: pointer;
    text-shadow: 1px 1px 2px rgba(0,0,0,.7);
  }
  #ww .questChecklist .checkItem:hover{
    background: rgba(0,0,0,.3);
    border-color: rgba(255,255,255,.2);
    transform: translateX(4px);
  }
  #ww .questChecklist .checkItem input[type="checkbox"]{
    width:24px; height:24px; 
    cursor:pointer;
    accent-color: var(--green);
    flex-shrink: 0;
  }
  #ww .questChecklist .checkItem.completed {
    opacity: .7;
    text-decoration: line-through;
  }
  #ww .questChecklist .checkItem .xpTag {
    margin-left: auto;
    background: rgba(255,211,110,.25);
    border: 2px solid var(--gold);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    color: var(--gold);
  }
  
  /* Quest Progress Bar */
  #ww .questProgress {
    margin: 16px 0;
    padding: 12px;
    background: rgba(0,0,0,.25);
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,.1);
  }
  #ww .questProgress .label {
    font-size: 13px;
    font-weight: 800;
    margin-bottom: 8px;
    color: var(--muted);
  }
  #ww .questProgress .bar {
    height: 12px;
  }
  
  #ww .questNote{
    background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    border:2px solid rgba(255,107,138,.5);
    border-radius:12px; padding:10px; margin:12px 0; font-weight:900; font-size:13px;
    color:var(--ink); text-shadow: 1px 1px 2px rgba(0,0,0,.7);
  }
  
  #ww .questFooter{display:flex; justify-content:space-between; align-items:center; margin-top:12px}
  #ww .xpBadge{
    background: rgba(255,211,110,.25); border:2px solid var(--gold);
    border-radius:999px; padding:6px 14px; font-weight:1000; font-size:14px;
    color:var(--gold);
  }
  
  #ww .questBtn{
    padding:14px 28px; border-radius:14px; border:none; font-weight:950; font-size:15px;
    cursor:pointer; color:#fff; 
    transition: all .3s ease;
    box-shadow: 0 6px 12px rgba(0,0,0,.4), inset 0 2px 0 rgba(255,255,255,.2);
    position: relative;
    overflow: hidden;
  }
  #ww .questBtn::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255,255,255,.3);
    transform: translate(-50%, -50%);
    transition: width .6s, height .6s;
  }
  #ww .questBtn:hover::before {
    width: 300px;
    height: 300px;
  }
  #ww .questBtn:hover{
    transform:translateY(-3px); 
    box-shadow:0 8px 20px rgba(0,0,0,.5), inset 0 2px 0 rgba(255,255,255,.3);
  }
  #ww .questBtn:active{
    transform:translateY(-1px);
    box-shadow:0 4px 8px rgba(0,0,0,.4);
  }
  #ww .questBtn.red{background: linear-gradient(135deg, #dc2626, #991b1b)}
  #ww .questBtn.green{background: linear-gradient(135deg, #10b981, #059669)}
  #ww .questBtn.blue{background: linear-gradient(135deg, #3b82f6, #1d4ed8)}
  #ww .questBtn.completed{
    background: linear-gradient(135deg, #6b7280, #4b5563);
    cursor: default;
  }
  
  /* Bottom Dashboard */
  #ww .dashboard{margin-top:24px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px}
  @media (max-width:980px){ #ww .dashboard{grid-template-columns:1fr} }
  
  #ww .dashPanel{
    border:3px solid var(--gold); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius:20px;
    box-shadow:var(--shadow), 0 0 20px rgba(255,211,110,.3); padding:20px;
  }
  
  #ww .dashPanel h3{
    margin:0 0 16px; font-size:18px; font-weight:1000; color:var(--gold);
    text-shadow: 2px 2px 0 rgba(0,0,0,.9);
  }
  
  #ww .xpDisplay{
    font-size:32px; font-weight:1000; color:var(--green); margin:12px 0;
    text-shadow: 2px 2px 0 rgba(0,0,0,.7);
  }
  
  #ww .streakInfo{
    font-size:18px; font-weight:900; margin:8px 0; color:var(--ink);
    text-shadow: 1px 1px 3px rgba(0,0,0,.7);
  }
  
  #ww .badgeGrid{display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-top:12px}
  @media (max-width:520px){ #ww .badgeGrid{grid-template-columns:repeat(2, 1fr)} }
  
  #ww .badgeItem{text-align:center}
  #ww .badgeIcon{
    width:80px; height:80px; border-radius:50%; border:4px solid var(--golden-border);
    background: linear-gradient(135deg, rgba(0,0,0,.6), rgba(0,0,0,.4)); 
    display:flex; align-items:center; justify-content:center;
    font-size:36px; margin:0 auto 10px; 
    box-shadow:0 6px 16px rgba(0,0,0,.5), 0 0 10px rgba(240,168,48,.2);
    transition: all .3s ease;
    position: relative;
  }
  #ww .badgeIcon.earned{
    background: linear-gradient(135deg, var(--gold), var(--orange), var(--gold)); 
    background-size: 200% 200%;
    border-color:var(--gold);
    animation: shimmer 2s linear infinite, glow 2s ease-in-out infinite;
    box-shadow:0 0 20px rgba(255,211,110,.6), 0 6px 16px rgba(0,0,0,.5);
  }
  #ww .badgeIcon.earned::after {
    content: "✨";
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 20px;
    animation: sparkle 1.5s ease-in-out infinite;
  }
  #ww .badgeIcon.locked{
    opacity:.3; 
    filter:grayscale(100%) brightness(.5);
    cursor: not-allowed;
  }
  #ww .badgeIcon:hover:not(.locked) {
    transform: scale(1.1) rotate(5deg);
  }
  #ww .badgeLabel{font-size:12px; font-weight:800; color:var(--muted)}
  
  #ww .weekGrid{display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; margin-top:12px}
  #ww .dayBox{
    aspect-ratio:1; border:2px solid var(--golden-border); background: var(--glass-bg);
    backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center;
    font-weight:900; font-size:12px; padding:8px;
  }
  #ww .dayBox.complete{background: rgba(125,255,180,.2); border-color:var(--green)}
  #ww .dayBox.complete::after{content:"✓"; display:block; font-size:20px; color:var(--green); margin-top:4px}
  
  #ww .treasureNote{
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
    border:2px solid var(--gold); border-radius:12px; padding:12px; margin-top:12px;
    font-weight:900; text-align:center; color:var(--gold);
    text-shadow: 1px 1px 3px rgba(0,0,0,.7);
  }

  /* Companion Title Display */
  #ww .companion .companionTitle {
    font-size: 12px;
    font-weight: 800;
    color: var(--gold);
    font-style: italic;
    margin-top: 2px;
    text-shadow: 1px 1px 2px rgba(0,0,0,.6);
  }

  /* War Chest Panel */
  #ww .warChestPanel {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 3px solid var(--gold);
    border-radius: 18px;
    padding: 16px;
    margin-top: 16px;
    text-align: center;
    box-shadow: 0 0 20px rgba(255,211,110,.2), 0 4px 12px rgba(0,0,0,.3);
  }
  #ww .warChestPanel h4 {
    margin: 0 0 8px;
    font-size: 20px;
    font-family: var(--fantasy-font);
    color: var(--gold);
    text-shadow: 2px 2px 0 rgba(0,0,0,.8), 0 0 15px rgba(255,211,110,.5);
  }
  #ww .warChestAmount {
    font-size: 36px;
    font-weight: 1000;
    color: var(--gold);
    text-shadow: 2px 2px 0 rgba(0,0,0,.7), 0 0 20px rgba(255,211,110,.4);
    margin: 8px 0;
    animation: pulse 2s ease-in-out infinite;
  }
  #ww .awardBtnRow {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  #ww .awardBtn {
    border: 2px solid var(--gold);
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    color: var(--gold);
    padding: 10px 16px;
    border-radius: 14px;
    cursor: pointer;
    font-weight: 900;
    font-size: 13px;
    transition: all .3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
  }
  #ww .awardBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,.4), 0 0 20px rgba(255,211,110,.5);
  }
  #ww .awardBtn:active {
    transform: translateY(0);
  }
  #ww .awardBtn:disabled {
    opacity: .4;
    cursor: not-allowed;
    transform: none;
  }

  /* Companion Reward Card Overlay */
  #companionRewardOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn .3s ease-out;
  }
  #companionRewardOverlay.show {
    display: flex;
  }
  #companionRewardOverlay .content {
    text-align: center;
    animation: celebrate .6s ease-out;
    padding: 40px;
  }
  #companionRewardOverlay .rewardEmoji {
    font-size: 100px;
    display: block;
    margin-bottom: 16px;
    animation: bounce 1s ease-in-out infinite;
  }
  #companionRewardOverlay .rewardHeading {
    font-size: 48px;
    font-family: var(--fantasy-font);
    color: var(--green);
    text-shadow:
      4px 4px 0 rgba(0,0,0,.9),
      0 0 30px rgba(125,255,180,.8),
      0 0 60px rgba(125,255,180,.5);
    margin: 0 0 12px;
    animation: pulse 1s ease-in-out infinite;
  }
  #companionRewardOverlay .rewardName {
    font-size: 32px;
    font-family: var(--fantasy-font);
    color: var(--gold);
    margin-bottom: 8px;
  }
  #companionRewardOverlay .rewardLevel {
    font-size: 24px;
    color: var(--ink);
    margin-bottom: 8px;
  }
  #companionRewardOverlay .rewardTitle {
    font-size: 28px;
    color: var(--gold);
    font-family: var(--fantasy-font);
    text-shadow: 2px 2px 4px rgba(0,0,0,.8);
  }
  #companionRewardOverlay .rewardPower {
    margin-top: 16px;
    font-size: 20px;
    color: var(--green);
    font-weight: 900;
    text-shadow: 0 0 10px rgba(125,255,180,.6);
    animation: pulse 1.5s ease-in-out infinite;
  }

  /* Level-Down Overlay */
  #levelDownOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(80,0,0,.90);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn .3s ease-out;
  }
  #levelDownOverlay.show {
    display: flex;
  }
  @keyframes shakeDown {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
  }
  #levelDownOverlay .content {
    text-align: center;
    animation: shakeDown .6s ease-out;
    padding: 40px;
  }
  #levelDownOverlay .content h2 {
    font-size: 72px;
    font-family: var(--fantasy-font);
    color: var(--red);
    text-shadow:
      4px 4px 0 rgba(0,0,0,.9),
      0 0 30px rgba(220,38,38,.8),
      0 0 60px rgba(220,38,38,.5);
    margin: 0 0 20px;
    animation: pulse 1s ease-in-out infinite;
  }
  #levelDownOverlay .levelInfo {
    font-size: 28px;
    color: var(--ink);
    margin-bottom: 10px;
  }
  #levelDownOverlay .levelTitle {
    font-size: 24px;
    color: var(--gold);
    font-family: var(--fantasy-font);
  }

  /* Weather Effects System */
  #weatherContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10001;
    overflow: hidden;
  }

  /* Rain effect */
  @keyframes rainFall {
    0% {
      transform: translateY(-100vh) translateX(0);
    }
    100% {
      transform: translateY(100vh) translateX(20px);
    }
  }

  .raindrop {
    position: absolute;
    width: 2px;
    height: 20px;
    background: linear-gradient(to bottom, transparent, rgba(174, 194, 224, 0.8));
    animation: rainFall linear infinite;
  }

  /* Snow effect */
  @keyframes snowFall {
    0% {
      transform: translateY(-100vh) translateX(0) rotate(0deg);
      opacity: 0.8;
    }
    100% {
      transform: translateY(100vh) translateX(50px) rotate(360deg);
      opacity: 0.4;
    }
  }

  .snowflake {
    position: absolute;
    color: white;
    font-size: 20px;
    animation: snowFall linear infinite;
    text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
  }

  /* Cloud effect */
  @keyframes cloudDrift {
    0% {
      transform: translateX(-20%);
    }
    100% {
      transform: translateX(120%);
    }
  }

  .cloud {
    position: absolute;
    opacity: 0.6;
    animation: cloudDrift linear infinite;
    font-size: 60px;
    filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
  }

  /* Lightning effect */
  @keyframes lightning {
    0%, 10%, 20%, 100% {
      opacity: 0;
    }
    5%, 15% {
      opacity: 1;
    }
  }

  #weatherLightning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    opacity: 0;
    pointer-events: none;
    z-index: 10001;
  }

  /* Weather toggle button */
  #weatherToggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 100;
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 2px solid var(--golden-border);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 28px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 15px rgba(212,165,48,0.3);
    transition: all 0.3s ease;
    pointer-events: auto;
  }

  #weatherToggle:hover {
    transform: scale(1.1) rotate(10deg);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4), 0 0 25px rgba(212,165,48,0.5);
  }

  #weatherToggle:active {
    transform: scale(0.95);
  }

  /* Weather menu */
  #weatherMenu {
    position: fixed;
    bottom: 90px;
    right: 20px;
    z-index: 99;
    background: var(--glass-strong-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 2px solid var(--golden-border);
    border-radius: 16px;
    padding: 12px;
    display: none;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(212,165,48,0.2);
    pointer-events: auto;
  }

  #weatherMenu.show {
    display: flex;
    animation: slideUp 0.3s ease-out;
  }

  .weatherOption {
    background: var(--glass-bg);
    border: 2px solid var(--golden-border);
    border-radius: 12px;
    padding: 10px 16px;
    cursor: pointer;
    font-weight: 800;
    font-size: 14px;
    color: var(--ink);
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  }

  .weatherOption:hover {
    background: rgba(255,211,110,0.2);
    border-color: var(--gold);
    transform: translateX(-4px);
  }

  .weatherOption.active {
    background: rgba(255,211,110,0.25);
    border-color: var(--gold);
    box-shadow: 0 0 10px rgba(255,211,110,0.4);
  }

  /* Audio Controls */
  #audioToggle {
    position: fixed;
    bottom: 20px;
    right: 90px;
    z-index: 100;
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 2px solid var(--golden-border);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 28px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 15px rgba(212,165,48,0.3);
    transition: all 0.3s ease;
    pointer-events: auto;
  }

  #audioToggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4), 0 0 25px rgba(212,165,48,0.5);
  }

  #audioToggle:active {
    transform: scale(0.95);
  }

  #audioToggle.muted {
    opacity: 0.5;
  }

  /* Audio Settings Panel */
  #audioSettings {
    position: fixed;
    bottom: 90px;
    right: 90px;
    z-index: 99;
    background: var(--glass-strong-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 2px solid var(--golden-border);
    border-radius: 16px;
    padding: 16px;
    display: none;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(212,165,48,0.2);
    pointer-events: auto;
    min-width: 220px;
  }

  #audioSettings.show {
    display: flex;
    animation: slideUp 0.3s ease-out;
  }

  #audioSettings h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: var(--gold);
    font-family: var(--fantasy-font);
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  }

  .audioControl {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .audioControl label {
    font-size: 12px;
    font-weight: 700;
    color: var(--ink);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .audioControl input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--glass-bg);
    border: 1px solid var(--golden-border);
    outline: none;
    -webkit-appearance: none;
  }

  .audioControl input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--gold);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .audioControl input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--gold);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .audioCheckbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: var(--glass-bg);
    border: 1px solid var(--golden-border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    color: var(--ink);
    transition: all 0.2s ease;
  }

  .audioCheckbox:hover {
    background: rgba(255,211,110,0.15);
    border-color: var(--gold);
  }

  .audioCheckbox input[type="checkbox"] {
    cursor: pointer;
  }

  /* Mobile responsiveness for audio controls */
  @media (max-width: 600px) {
    #audioToggle {
      bottom: 90px;
      right: 20px;
      width: 50px;
      height: 50px;
      font-size: 24px;
    }

    #audioSettings {
      bottom: 150px;
      right: 20px;
      min-width: 180px;
    }
  }
  
  /* ============================================
     MORNING MISSION STYLES
     ============================================ */
  
  /* Mission Timer */
  .missionTimer {
    background: linear-gradient(135deg, var(--glass-strong-bg), rgba(30,20,50,0.4));
    backdrop-filter: var(--glass-blur);
    border: 2px solid var(--golden-border);
    border-radius: var(--r2);
    padding: 12px 16px;
    margin: 12px 0;
    text-align: center;
    font-family: var(--fantasy-font);
    animation: glow 2s ease-in-out infinite;
  }
  
  .missionTimer.locked {
    background: linear-gradient(135deg, rgba(60,60,60,0.3), rgba(40,40,40,0.3));
    border-color: #666;
    animation: none;
  }
  
  .missionTimer.active {
    background: linear-gradient(135deg, rgba(20,120,20,0.3), rgba(10,80,10,0.3));
    border-color: var(--green);
  }
  
  .missionTimer.active.warning {
    background: linear-gradient(135deg, rgba(200,140,20,0.3), rgba(150,100,10,0.3));
    border-color: var(--gold);
    animation: pulse 1s ease-in-out infinite;
  }
  
  .missionTimer.active.critical {
    background: linear-gradient(135deg, rgba(200,20,20,0.3), rgba(150,10,10,0.3));
    border-color: var(--red);
    animation: pulse 0.5s ease-in-out infinite;
  }
  
  .missionTimer strong {
    font-size: 1.4em;
    color: var(--gold);
  }
  
  .missionTimer .deadline {
    font-size: 0.85em;
    opacity: 0.8;
    display: block;
    margin-top: 4px;
  }
  
  /* Mission Status Banner */
  .missionStatusBanner {
    background: linear-gradient(135deg, var(--glass-strong-bg), rgba(30,20,50,0.4));
    backdrop-filter: var(--glass-blur);
    border: 2px solid;
    border-radius: var(--r2);
    padding: 12px 16px;
    margin: 12px 0;
    text-align: center;
    font-family: var(--fantasy-font);
    font-size: 1.1em;
  }
  
  .missionStatusBanner.success {
    background: linear-gradient(135deg, rgba(20,150,20,0.4), rgba(10,100,10,0.4));
    border-color: var(--green);
    animation: celebrate 0.6s ease-out;
  }
  
  .missionStatusBanner.failed {
    background: linear-gradient(135deg, rgba(150,20,20,0.4), rgba(100,10,10,0.4));
    border-color: var(--red);
  }
  
  .missionStatusBanner .small {
    font-size: 0.85em;
    opacity: 0.9;
    margin-top: 4px;
    display: block;
  }
  
  /* Bomb Visual */
  .bombVisual {
    background: linear-gradient(135deg, rgba(40,30,60,0.5), rgba(30,20,50,0.5));
    backdrop-filter: var(--glass-blur);
    border: 2px solid rgba(200,148,42,0.3);
    border-radius: var(--r2);
    padding: 16px;
    margin: 12px 0;
    text-align: center;
  }
  
  .bombProgress {
    font-family: var(--fantasy-font);
    font-size: 1.1em;
    margin-bottom: 12px;
    color: var(--gold);
  }
  
  .bombEmoji {
    font-size: 3em;
    margin: 8px 0;
    animation: pulse 2s ease-in-out infinite;
  }
  
  .bombVisual.disarmed .bombEmoji {
    animation: none;
  }
  
  .bombVisual.exploded .bombEmoji {
    animation: william-shake 0.3s ease-in-out 3;
  }
  
  .bombDisarmed,
  .bombExploded {
    font-size: 1.5em;
    font-family: var(--fantasy-font);
    margin: 12px 0;
  }
  
  .bombDisarmed {
    color: var(--green);
    animation: celebrate 0.6s ease-out;
  }
  
  .bombExploded {
    color: var(--red);
    animation: william-shake 0.3s ease-in-out;
  }
  
  /* Wires Container */
  .wiresContainer {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 12px;
  }
  
  .wire {
    width: 60px;
    height: 8px;
    border-radius: 4px;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .wire::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
    border-radius: 4px;
  }
  
  .wire.cut {
    height: 4px;
    opacity: 0.3;
    transform: scaleX(0.5);
    box-shadow: none;
  }
  
  /* Wire Badges on Tasks */
  .wireBadge {
    display: inline-block;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    margin-right: 8px;
    font-size: 0.9em;
    border: 2px solid rgba(255,255,255,0.3);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .wireBadge.cut {
    opacity: 0.4;
    border-style: dashed;
    position: relative;
  }
  
  .wireBadge.cut::after {
    content: '✂️';
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 0.7em;
  }
  
  /* Mission Overlays */
  .missionOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .missionOverlay.show {
    opacity: 1;
  }
  
  .missionOverlayContent {
    background: linear-gradient(135deg, var(--panel), rgba(40,30,60,0.95));
    border: 3px solid var(--golden-border);
    border-radius: var(--r1);
    padding: 40px;
    max-width: 500px;
    text-align: center;
    position: relative;
    animation: celebrate 0.6s ease-out;
  }
  
  .missionOverlay.failed .missionOverlayContent {
    border-color: var(--red);
    animation: william-shake 0.4s ease-in-out;
  }
  
  .williamHero,
  .williamSooty {
    font-size: 5em;
    margin-bottom: 20px;
    animation: william-bounce-rotate 0.8s ease-out;
  }
  
  .missionOverlay h2 {
    font-family: var(--fantasy-font);
    font-size: 2.2em;
    margin: 0 0 20px;
    color: var(--gold);
  }
  
  .missionOverlay.failed h2 {
    color: var(--red);
  }
  
  .missionStats {
    font-size: 1.1em;
    line-height: 1.8;
  }
  
  .missionStats > div {
    margin: 8px 0;
  }
  
  /* Confetti Animation */
  .confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    animation: confettiFall 3s ease-out forwards;
  }
  
  @keyframes confettiFall {
    0% {
      top: -20px;
      opacity: 1;
      transform: translateY(0) rotate(0deg);
    }
    100% {
      top: 100%;
      opacity: 0;
      transform: translateY(100px) rotate(720deg);
    }
  }
  
  /* Smoke Animation */
  .smoke {
    position: absolute;
    font-size: 2em;
    animation: smokeFly 2s ease-out forwards;
    opacity: 0.8;
  }
  
  @keyframes smokeFly {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }
    100% {
      transform: translateY(-100px) scale(2);
      opacity: 0;
    }
  }
</style>

<!-- Weather Effects Container -->
<div id="weatherContainer"></div>
<div id="weatherLightning"></div>

<!-- Weather Toggle Button -->
<div id="weatherToggle" title="Weather Effects">🌤️</div>

<!-- Weather Menu -->
<div id="weatherMenu">
  <div class="weatherOption" data-weather="none">
    <span>☀️</span> Clear
  </div>
  <div class="weatherOption" data-weather="rain">
    <span>🌧️</span> Rain
  </div>
  <div class="weatherOption" data-weather="snow">
    <span>❄️</span> Snow
  </div>
  <div class="weatherOption" data-weather="clouds">
    <span>☁️</span> Cloudy
  </div>
  <div class="weatherOption" data-weather="storm">
    <span>⛈️</span> Storm
  </div>
</div>

<!-- Audio Toggle Button -->
<div id="audioToggle" title="Audio Settings">🔊</div>

<!-- Audio Settings Panel -->
<div id="audioSettings">
  <h3>🎵 Audio Settings</h3>
  
  <div class="audioControl">
    <label>
      <span>🎶 Music</span>
      <span id="musicVolumeValue">20%</span>
    </label>
    <input type="range" id="musicVolume" min="0" max="100" value="20">
  </div>
  
  <div class="audioControl">
    <label>
      <span>🌧️ Ambience</span>
      <span id="ambienceVolumeValue">30%</span>
    </label>
    <input type="range" id="ambienceVolume" min="0" max="100" value="30">
  </div>
  
  <div class="audioControl">
    <label>
      <span>🔔 Sound FX</span>
      <span id="sfxVolumeValue">70%</span>
    </label>
    <input type="range" id="sfxVolume" min="0" max="100" value="70">
  </div>
  
  <div class="audioCheckbox">
    <input type="checkbox" id="reduceSoundMode">
    <label for="reduceSoundMode" style="cursor: pointer; margin: 0;">Reduce Sound Mode</label>
  </div>
</div>


<div id="ww">
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logoMark"><img id="logoImg" alt="William's World"></div>
          <div>
            <div>William's World</div>
            <div class="small">Quest UI • daily wins → XP → levels → streak rewards</div>
          </div>
          <span class="badge" id="todayLabel">Today</span>
        </div>
        <div class="nav">
          <button class="active" data-section="home">Home</button>
          <button data-section="tracker">Tracker</button>
          <button data-section="party">Party</button>
          <button data-section="map">Map</button>
          <button onclick="window.location.href='games/index.html'">🎮 Games</button>
          <button onclick="window.location.href='battle-system-demo.html'">⚔️ Battle System</button>
        </div>
      </div>
    </div>

    <section class="banner" data-banner id="home">
      <div class="banner-inner">
        <div class="william-avatar" id="williamAvatar">
          <img id="williamImg" alt="William character avatar" />
        </div>
        <div>
          <h1>Welcome to William's World!</h1>
          <div class="levelTitle" id="levelTitle">Apprentice Adventurer</div>
          <p>Complete daily quests to earn XP, level up, and unlock amazing rewards. Your adventure begins now!</p>

          <div class="statRow">
            <div class="pill"><span class="dot"></span> Level <span id="levelNum">1</span></div>
            <div class="pill hpPill"><span class="dot"></span> HP <span id="hpNum">100</span>/<span id="hpMaxPill">100</span></div>
            <div class="pill"><span class="dot green"></span> Streak <span id="streakNum">0</span> days</div>
            <div class="pill"><span class="dot gold"></span> Today: <span id="dayResult">Not graded</span></div>
          </div>

          <div class="meter">
            <div class="meterTop">
              <div><b>XP</b>: <span id="xpNow">0</span> / <span id="xpNext">100</span></div>
              <div class="small">Complete all quests to earn rewards!</div>
            </div>
            <div class="bar"><div id="xpBar"></div></div>
          </div>
          <div class="meter hpMeter" id="hpMeterBanner">
            <div class="meterTop">
              <div><b>❤️ HP</b>: <span id="hpNow">100</span> / <span id="hpMax">100</span></div>
              <div class="small">Missed tasks deal damage at midnight!</div>
            </div>
            <div class="bar"><div id="hpBar"></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Content with Sidebar Layout -->
    <div class="contentWithSidebar">
      <!-- Sidebar with Quest Tracker and Map -->
      <aside class="questSidebar">
        <!-- Current Quest Header -->
        <div class="currentQuestHeader">
          <h2>🎯 Current Quest <span class="tag">DAILY</span></h2>
          <div class="small" style="margin-top:8px;">Complete all quests to pass the day!</div>
        </div>

        <!-- Quest Map with Icons -->
        <div class="questMapSidebar">
          <h3>🗺️ Quest Map</h3>
          <div class="zoneIconList">
            <div class="zoneIconItem unlocked" id="zoneIcon1">
              <div class="zoneIconSmall">
                <img id="zone1IconImg" alt="Launch Meadow">
              </div>
              <div class="zoneIconInfo">
                <div class="zoneIconName">Launch Meadow</div>
                <div class="zoneIconStatus">✓ Unlocked</div>
              </div>
            </div>
            <div class="zoneIconItem locked" id="zoneIcon2">
              <div class="zoneIconSmall">
                <img id="zone2IconImg" alt="Homework Hills">
              </div>
              <div class="zoneIconInfo">
                <div class="zoneIconName">Homework Hills</div>
                <div class="zoneIconStatus">🔒 3 days</div>
              </div>
            </div>
            <div class="zoneIconItem locked" id="zoneIcon3">
              <div class="zoneIconSmall">
                <img id="zone3IconImg" alt="Backpack Bastion">
              </div>
              <div class="zoneIconInfo">
                <div class="zoneIconName">Backpack Bastion</div>
                <div class="zoneIconStatus">🔒 5 days</div>
              </div>
            </div>
            <div class="zoneIconItem locked" id="zoneIcon4">
              <div class="zoneIconSmall">
                <img id="zone4IconImg" alt="Focus Forest">
              </div>
              <div class="zoneIconInfo">
                <div class="zoneIconName">Focus Forest</div>
                <div class="zoneIconStatus">🔒 10 days</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quest Cards in Sidebar -->
        <div class="questGrid" id="tracker">
      <!-- Quest 1: Win Tomorrow Tonight -->
      <div class="questCard night" id="questNight">
        <div class="questIcon">🌙</div>
        <h3>Win Tomorrow Tonight</h3>
        <div class="questChecklist">
          <label class="checkItem" data-task="n_trapper">
            <input type="checkbox">
            <span>Trapper Ready</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="n_clothes">
            <input type="checkbox">
            <span>Clothes Ready</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="n_lunch">
            <input type="checkbox">
            <span>Lunch Plan Ready</span>
            <span class="xpTag">+10 XP</span>
          </label>
          <label class="checkItem" data-task="n_shoes">
            <input type="checkbox">
            <span>Shoes + Jacket Ready</span>
            <span class="xpTag">+10 XP</span>
          </label>
        </div>
        <div class="questProgress">
          <div class="label"><span class="progressText">0/4 tasks</span></div>
          <div class="bar"><div class="progressBar"></div></div>
        </div>
        <div class="questNote">No Screen Time Until Done!</div>
        <div class="questFooter">
          <div class="xpBadge">Total: +50 XP</div>
        </div>
      </div>

      <!-- Quest 2: Ready for School! -->
      <div class="questCard morning" id="questMorning">
        <div class="questIcon">☀️</div>
        <h3>Ready for School!</h3>
        <div class="questChecklist">
          <label class="checkItem" data-task="m_prayer">
            <input type="checkbox">
            <span>Prayer & Breakfast</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="m_dressed">
            <input type="checkbox">
            <span>Get Dressed</span>
            <span class="xpTag">+10 XP</span>
          </label>
          <label class="checkItem" data-task="m_teeth">
            <input type="checkbox">
            <span>Brush Teeth & Hair</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="m_trappercheck">
            <input type="checkbox">
            <span>Backpack Check</span>
            <span class="xpTag">+10 XP</span>
          </label>
        </div>
        <div class="questProgress">
          <div class="label"><span class="progressText">0/4 tasks</span></div>
          <div class="bar"><div class="progressBar"></div></div>
        </div>
        <div class="questFooter">
          <div class="xpBadge">Total: +50 XP</div>
        </div>
      </div>

      <!-- Quest 3: Trapper Ready Mission! -->
      <div class="questCard backpack" id="questBackpack">
        <div class="questIcon">⭐</div>
        <h3>Trapper Ready Mission!</h3>
        <div class="questChecklist">
          <label class="checkItem" data-task="t_work">
            <input type="checkbox">
            <span>Work & Papers</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="t_notebooks">
            <input type="checkbox">
            <span>Notebooks Inside</span>
            <span class="xpTag">+10 XP</span>
          </label>
          <label class="checkItem" data-task="t_supplies">
            <input type="checkbox">
            <span>Supplies Packed</span>
            <span class="xpTag">+15 XP</span>
          </label>
          <label class="checkItem" data-task="t_check">
            <input type="checkbox">
            <span>Final Check</span>
            <span class="xpTag">+10 XP</span>
          </label>
        </div>
        <div class="questProgress">
          <div class="label"><span class="progressText">0/4 tasks</span></div>
          <div class="bar"><div class="progressBar"></div></div>
        </div>
        <div class="questFooter">
          <div class="xpBadge">Total: +50 XP</div>
        </div>
      </div>
    </div>
    </aside>

    <!-- Main Content Area -->
    <div class="mainContent">
      <!-- Bottom Dashboard -->
    <div class="dashboard">
      <!-- XP & Streaks Panel -->
      <div class="dashPanel">
        <h3>XP & Streaks</h3>
        <div class="xpDisplay" id="dashXP">0</div>
        <div class="streakInfo"><span class="streakFire">🔥</span> <span id="dashStreak">0</span> Days Streak</div>
        <div class="small" style="margin-top:8px;">❤️ HP: <span id="dashHP">100</span>/<span id="dashHPMax">100</span></div>
        <div class="meter hpMeter" style="margin-top:6px;" id="hpMeterDash">
          <div class="bar"><div id="dashHPBar"></div></div>
        </div>
        <div class="small" style="margin-top:8px;">Next Badge: <span id="nextBadge">Bronze Shield</span></div>
        <div class="meter" style="margin-top:12px;">
          <div class="meterTop">
            <div class="small">Progress to Next Level</div>
          </div>
          <div class="bar"><div id="dashXPBar"></div></div>
        </div>
      </div>

      <!-- Streak Milestone Badges -->
      <div class="dashPanel">
        <h3>Streak Milestones</h3>
        <div class="badgeGrid">
          <div class="badgeItem">
            <div class="badgeIcon locked" id="streakBadge3">🛡️</div>
            <div class="badgeLabel">Bronze Shield<br>(3 days)</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="streakBadge5">⚔️</div>
            <div class="badgeLabel">Silver Sword<br>(5 days)</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="streakBadge7">👑</div>
            <div class="badgeLabel">Gold Crown<br>(7 days)</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="streakBadge10">🐉</div>
            <div class="badgeLabel">Diamond Dragon<br>(10 days)</div>
          </div>
        </div>
      </div>

      <!-- Task Badges -->
      <div class="dashPanel">
        <h3>Task Badges</h3>
        <div class="badgeGrid">
          <div class="badgeItem">
            <div class="badgeIcon locked" id="badge1">🎒</div>
            <div class="badgeLabel">Trapper Master</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="badge2">🏆</div>
            <div class="badgeLabel">Perfect Day</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="badge3">⭐</div>
            <div class="badgeLabel">Streak Star</div>
          </div>
          <div class="badgeItem">
            <div class="badgeIcon locked" id="badge4">✓</div>
            <div class="badgeLabel">No Missing Items</div>
          </div>
        </div>
      </div>
    </div>
    </div> <!-- end mainContent -->
    </div> <!-- end contentWithSidebar -->

    <!-- Companion Party Section -->
    <div id="party" style="margin-top:24px;">
      <div class="dashPanel">
        <h3>🎮 Companion Party</h3>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-top:16px;">
          <div class="companion" id="companionEmber">
            <div class="header">
              <div class="avatar">
                <img id="emberImg" alt="Ember">
              </div>
              <div class="info">
                <div class="name">Ember</div>
                <div class="type">🔥 Fire Tiger</div>
                <div class="level">Lvl <span class="companionLevel">1</span></div>
                <div class="companionTitle" id="emberTitle"></div>
              </div>
            </div>
            <div class="statBar">
              <div class="statLabel">XP Progress</div>
              <div class="bar"><div class="companionXPBar"></div></div>
            </div>
          </div>
          
          <div class="companion" id="companionSprite">
            <div class="header">
              <div class="avatar">
                <img id="spriteImg" alt="Sprite">
              </div>
              <div class="info">
                <div class="name">Sprite</div>
                <div class="type">✨ Light Fairy</div>
                <div class="level">Lvl <span class="companionLevel">1</span></div>
                <div class="companionTitle" id="spriteTitle"></div>
              </div>
            </div>
            <div class="statBar">
              <div class="statLabel">XP Progress</div>
              <div class="bar"><div class="companionXPBar"></div></div>
            </div>
          </div>
          
          <div class="companion" id="companionGolem">
            <div class="header">
              <div class="avatar">
                <img id="golemImg" alt="Golem">
              </div>
              <div class="info">
                <div class="name">Golem</div>
                <div class="type">🗿 Stone Guardian</div>
                <div class="level">Lvl <span class="companionLevel">1</span></div>
                <div class="companionTitle" id="golemTitle"></div>
              </div>
            </div>
            <div class="statBar">
              <div class="statLabel">XP Progress</div>
              <div class="bar"><div class="companionXPBar"></div></div>
            </div>
          </div>
        </div>
        <div class="warChestPanel" id="warChestPanel">
          <h4>⚔️ War Chest ⚔️</h4>
          <div class="warChestAmount"><span id="warChestGold">0</span> 🪙</div>
          <div class="small" style="color:var(--muted);">Award 50 gold to a companion!</div>
          <div class="awardBtnRow">
            <button class="awardBtn" data-award="ember">🔥 Award Ember</button>
            <button class="awardBtn" data-award="sprite">✨ Award Sprite</button>
            <button class="awardBtn" data-award="golem">🗿 Award Golem</button>
          </div>
        </div>
      </div>
    </div>

    <!-- World Map Section -->
    <div id="map" style="margin-top:24px;">
      <div class="dashPanel">
        <h3>🗺️ World Map - Zone Progress</h3>
        <div style="display:grid; gap:16px; margin-top:16px;">
          <div class="zone unlocked" id="zone1">
            <div class="zoneIcon">
              <img id="zone1Img" alt="Launch Meadow">
            </div>
            <div class="zoneInfo">
              <div class="zoneName">Launch Meadow</div>
              <div class="zoneStatus unlocked">✓ UNLOCKED!</div>
            </div>
          </div>
          
          <div class="zone locked" id="zone2">
            <div class="zoneIcon">
              <img id="zone2Img" alt="Homework Hills">
            </div>
            <div class="zoneInfo">
              <div class="zoneName">Homework Hills</div>
              <div class="zoneStatus locked">🔒 Unlocks at 3 days</div>
            </div>
            <div class="lockIcon">🔒</div>
          </div>
          
          <div class="zone locked" id="zone3">
            <div class="zoneIcon">
              <img id="zone3Img" alt="Backpack Bastion">
            </div>
            <div class="zoneInfo">
              <div class="zoneName">Backpack Bastion</div>
              <div class="zoneStatus locked">🔒 Unlocks at 5 days</div>
            </div>
            <div class="lockIcon">🔒</div>
          </div>
          
          <div class="zone locked" id="zone4">
            <div class="zoneIcon">
              <img id="zone4Img" alt="Focus Forest">
            </div>
            <div class="zoneInfo">
              <div class="zoneName">Focus Forest</div>
              <div class="zoneStatus locked">🔒 Unlocks at 10 days</div>
            </div>
            <div class="lockIcon">🔒</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Tracker -->
    <div style="margin-top:24px;">
      <div class="dashPanel">
        <h3>📅 Weekly Tracker Reward ⭐</h3>
        <div class="treasureNote">5 Organized Days = PRIZE!</div>
        <div class="weekGrid" id="weekGrid">
          <div class="dayBox" data-day="mon"><div>Mon</div></div>
          <div class="dayBox" data-day="tue"><div>Tue</div></div>
          <div class="dayBox" data-day="wed"><div>Wed</div></div>
          <div class="dayBox" data-day="thu"><div>Thu</div></div>
          <div class="dayBox" data-day="fri"><div>Fri</div></div>
        </div>
      </div>
    </div>

    <!-- Hidden detailed task list for backward compatibility -->
    <div style="display:none;">
      <section class="card">
        <h2>Daily Checklist <span class="tag">XP + Streak</span></h2>
        <div class="frame"><div class="small"><b>PASS rule:</b> all Night-Before tasks + Trapper Check complete.</div></div>
        <div class="taskList" id="taskList"></div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  
  <!-- Level Up Celebration Overlay -->
  <div id="levelUpOverlay">
    <div class="content">
      <div class="william-avatar-overlay" id="williamAvatarOverlay">
        <img id="williamImgOverlay" alt="William character avatar" />
      </div>
      <h2>LEVEL UP!</h2>
      <div class="levelInfo">Level <span id="levelUpNumber"></span></div>
      <div class="levelTitle" id="levelUpTitle"></div>
    </div>
  </div>
  
  <!-- William Rest State Overlay -->
  <div id="williamRestOverlay">
    <div class="message">💤 I'm on a break for a minute. 💤</div>
    <div class="countdown">Time remaining: <span id="restCountdown">60</span>s</div>
    <div class="zzz">Zzz...</div>
  </div>
  
  <!-- Companion Reward Card Overlay -->
  <div id="companionRewardOverlay">
    <div class="content">
      <span class="rewardEmoji" id="rewardEmoji"></span>
      <div class="rewardHeading">COMPANION LEVEL UP!</div>
      <div class="rewardName" id="rewardCompName"></div>
      <div class="rewardLevel">Level <span id="rewardCompLevel"></span></div>
      <div class="rewardTitle" id="rewardCompTitle"></div>
      <div class="rewardPower">⚡ New Power Unlocked! ⚡</div>
    </div>
  </div>

  <!-- Level Down Overlay -->
  <div id="levelDownOverlay">
    <div class="content">
      <h2>💀 LEVEL DOWN! 💀</h2>
      <div class="levelInfo">Dropped to Level <span id="levelDownNumber"></span></div>
      <div class="levelTitle" id="levelDownTitle"></div>
    </div>
  </div>
</div>

<!-- Howler.js Audio Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js" integrity="sha512-xi/RZRIF/S0hJ+yJJYuZ5yk6/8pCiRlEXZzoguSMl+vk2i3m6UjUO/WcZ11blRL/O+rnj94JRGwt/CHbc9+6EA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  const ASSETS = {
    mapstrip: "./assets/images/mapstrip.svg",
    banner:   "./assets/images/banner.svg",
    logo:     "./assets/images/williamsworldlogo.png",
    william: {
      level1: "./assets/images/Williams avatar.PNG",
      level2: "./assets/images/Williams avatar.PNG",
      level3: "./assets/images/Williams avatar.PNG",
    },
    companions: {
      ember:  "./assets/images/companion_ember_512.png",
      sprite: "./assets/images/companion_sprite_512.png",
      golem:  "./assets/images/companion_golem_512.png",
    },
    
    // Zone images for quest map
    zones: {
      z1: "./assets/images/zone_launch_256.png",
      z2: "./assets/images/zone_homework_256.png",
      z3: "./assets/images/backpackbastion.png",
      z4: "./assets/images/zone_focus_256.png",
    }
  };
  
  // D&D-Style Level Titles
  const LEVEL_TITLES = {
    1: "Apprentice Adventurer",
    2: "Brave Scout",
    3: "Squire of the Realm",
    4: "Woodland Ranger",
    5: "Knight of Focus",
    6: "Battle Mage",
    7: "Dungeon Explorer",
    8: "Dragon Slayer",
    9: "Quest Master",
    10: "Quest Champion",
    11: "Elite Warrior",
    12: "Arcane Sage",
    13: "Shadow Hunter",
    14: "Storm Bringer",
    15: "Legendary Hero",
    16: "Realm Protector",
    17: "Titan Slayer",
    18: "Cosmic Guardian",
    19: "Eternal Champion",
    20: "Dragon Master"
  };
  
  const getLevelTitle = (level) => {
    if (level <= 20) return LEVEL_TITLES[level];
    return "Dragon Master";
  };
  
  // Get William's character image based on current level
  function getWilliamImage(level) {
    if (level >= 14) return ASSETS.william.level3;  // Epic/powered-up form
    if (level >= 7) return ASSETS.william.level2;    // Armored/mid-tier form
    return ASSETS.william.level1;                     // Base/casual form
  }

  // Companion Level Titles
  const COMPANION_TITLES = {
    ember: {
      1: "Tiny Spark", 2: "Flickering Flame", 3: "Blaze Cub", 4: "Fire Prowler",
      5: "Inferno Striker", 6: "Magma Fang", 7: "Volcanic Hunter", 8: "Phoenix Fury",
      9: "Solar Beast", 10: "Eternal Inferno"
    },
    sprite: {
      1: "Dim Glimmer", 2: "Sparkle Wisp", 3: "Glow Dancer", 4: "Shimmer Wing",
      5: "Radiant Pixie", 6: "Starlight Weaver", 7: "Aurora Enchanter", 8: "Prismatic Sage",
      9: "Celestial Beacon", 10: "Eternal Luminary"
    },
    golem: {
      1: "Pebble Scout", 2: "Rock Tumbler", 3: "Boulder Buddy", 4: "Granite Guard",
      5: "Iron Fortress", 6: "Steel Sentinel", 7: "Diamond Wall", 8: "Obsidian Titan",
      9: "Mountain King", 10: "Eternal Colossus"
    }
  };
  const COMPANION_MAX_TITLES = { ember: "Supernova Tiger", sprite: "Supernova Fairy", golem: "World Shaker" };
  const COMPANION_EMOJIS = { ember: "🔥", sprite: "✨", golem: "🗿" };
  const COMPANION_NAMES = { ember: "Ember", sprite: "Sprite", golem: "Golem" };

  function getCompanionTitle(companion, level) {
    if (level >= 11) return COMPANION_MAX_TITLES[companion];
    return COMPANION_TITLES[companion][level] || COMPANION_MAX_TITLES[companion];
  }

  const KEY = "williams_world_embed_state_v1";
  const WAR_CHEST_XP_RATE = 0.25;       // 25% of task XP goes to war chest
  const WAR_CHEST_AWARD_COST = 50;      // Gold cost per companion award
  const COMPANION_XP_PER_LEVEL = 100;   // XP needed for companion level-up
  const LEVEL_DOWN_HP_RESET = 50;       // HP after level-down
  const HP_PER_STREAK = 100;            // Extra max HP per streak day
  const TASKS = [
    // Night-Before Quest
    { id:"n_trapper",  label:"Night-Before: Trapper ready", xp:15, quest:"night" },
    { id:"n_clothes",  label:"Night-Before: Clothes ready", xp:15, quest:"night" },
    { id:"n_lunch",    label:"Night-Before: Lunch plan ready", xp:10, quest:"night" },
    { id:"n_shoes",    label:"Night-Before: Shoes + Jacket ready", xp:10, quest:"night" },
    // Morning Quest
    { id:"m_prayer",   label:"Morning: Prayer & Breakfast", xp:15, quest:"morning" },
    { id:"m_dressed",  label:"Morning: Get dressed", xp:10, quest:"morning" },
    { id:"m_teeth",    label:"Morning: Brush teeth & hair", xp:15, quest:"morning" },
    { id:"m_trappercheck", label:"Morning: Backpack check", xp:10, quest:"morning" },
    // Trapper/Backpack Quest
    { id:"t_work",     label:"Trapper: Work & Papers", xp:15, quest:"backpack" },
    { id:"t_notebooks",label:"Trapper: Notebooks inside", xp:10, quest:"backpack" },
    { id:"t_supplies", label:"Trapper: Supplies packed", xp:15, quest:"backpack" },
    { id:"t_check",    label:"Trapper: Final check", xp:10, quest:"backpack" },
  ];

  const MAP = [
    { id:"z1", title:"Launch Meadow", need:1 },
    { id:"z2", title:"Homework Hills", need:3 },
    { id:"z3", title:"Backpack Bastion", need:5 },
    { id:"z4", title:"Focus Forest", need:10 },
  ];
  
  const COMPANIONS = ["ember", "sprite", "golem"];

  // ============================================
  // MORNING MISSION CONSTANTS
  // ============================================
  const MORNING_MISSION = {
    TIMEZONE: 'America/Chicago',
    WINDOW_START_HOUR: 6,  // 6:00 AM
    WINDOW_START_MIN: 0,
    DEADLINE_HOUR: 8,       // 8:00 AM
    DEADLINE_MIN: 0,
    RESET_HOUR: 4,          // 4:00 AM daily reset
    RESET_MIN: 0,
    HP_PER_TASK: 5,         // HP reward per task
    HP_COMPLETION_BONUS: 10, // Bonus for completing all before deadline
    STREAK_BONUS_HP: 5,      // HP bonus every 3 consecutive successes
    STREAK_BONUS_INTERVAL: 3,
    OVERLAY_FADE_DURATION: 500, // Milliseconds for overlay fade out
    CONFETTI_COUNT: 30,      // Number of confetti particles
    SMOKE_PUFF_COUNT: 8,     // Number of smoke puffs
    WIRE_COLORS: {
      'm_prayer': { color: '#dc2626', label: 'Red', icon: '🍳' },      // Fire/breakfast
      'm_dressed': { color: '#22c55e', label: 'Green', icon: '👕' },   // Grass/clothes
      'm_teeth': { color: '#3b82f6', label: 'Blue', icon: '🪥' },      // Water/teeth
      'm_trappercheck': { color: '#a855f7', label: 'Purple', icon: '🎒' } // Magic/backpack
    }
  };

  const $ = (id)=>document.getElementById(id);
  const todayKey = ()=>{
    const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  };
  const prettyToday = ()=>new Date().toLocaleDateString(undefined,{weekday:"short",month:"short",day:"numeric"});

  const xpForLevel = (lvl)=> 100 + (lvl-1)*20;

  // ============================================
  // TIME UTILITY FUNCTIONS (America/Chicago)
  // ============================================
  
  // Get current date/time in America/Chicago timezone
  function getChicagoTime() {
    // Use a more reliable timezone conversion approach
    const utcDate = new Date();
    const chicagoTimeString = utcDate.toLocaleString('en-US', { 
      timeZone: MORNING_MISSION.TIMEZONE,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    // Parse the formatted string (MM/DD/YYYY, HH:mm:ss format)
    const parts = chicagoTimeString.match(/(\d+)\/(\d+)\/(\d+),\s+(\d+):(\d+):(\d+)/);
    if (parts) {
      return new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5], parts[6]);
    }
    
    // Fallback to UTC if parsing fails
    return utcDate;
  }
  
  // Get today's date key in Chicago timezone
  function getChicagoDateKey() {
    const d = getChicagoTime();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  
  // Check if current time is within morning window (6:00-8:00 AM Chicago)
  function isInMorningWindow() {
    const now = getChicagoTime();
    const hour = now.getHours();
    const min = now.getMinutes();
    
    const afterStart = (hour > MORNING_MISSION.WINDOW_START_HOUR) || 
                       (hour === MORNING_MISSION.WINDOW_START_HOUR && min >= MORNING_MISSION.WINDOW_START_MIN);
    const beforeDeadline = (hour < MORNING_MISSION.DEADLINE_HOUR) || 
                           (hour === MORNING_MISSION.DEADLINE_HOUR && min < MORNING_MISSION.DEADLINE_MIN);
    
    return afterStart && beforeDeadline;
  }
  
  // Check if deadline has passed
  function isMorningDeadlinePassed() {
    const now = getChicagoTime();
    const hour = now.getHours();
    const min = now.getMinutes();
    
    return (hour > MORNING_MISSION.DEADLINE_HOUR) || 
           (hour === MORNING_MISSION.DEADLINE_HOUR && min >= MORNING_MISSION.DEADLINE_MIN);
  }
  
  // Check if before morning window
  function isBeforeMorningWindow() {
    const now = getChicagoTime();
    const hour = now.getHours();
    const min = now.getMinutes();
    
    return (hour < MORNING_MISSION.WINDOW_START_HOUR) || 
           (hour === MORNING_MISSION.WINDOW_START_HOUR && min < MORNING_MISSION.WINDOW_START_MIN);
  }
  
  // Get time remaining until deadline (in milliseconds)
  function getTimeUntilDeadline() {
    const now = getChicagoTime();
    const deadline = new Date(now);
    deadline.setHours(MORNING_MISSION.DEADLINE_HOUR, MORNING_MISSION.DEADLINE_MIN, 0, 0);
    
    // If deadline already passed today, return 0
    if (deadline <= now) return 0;
    
    return deadline - now;
  }
  
  // Format time remaining as MM:SS
  function formatTimeRemaining(ms) {
    if (ms <= 0) return '00:00';
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }
  
  // Get mission window string for tooltips
  function getMissionWindowString() {
    return `Morning Mission runs ${MORNING_MISSION.WINDOW_START_HOUR}:00–${MORNING_MISSION.DEADLINE_HOUR}:00 AM.`;
  }

  // ============================================
  // AUDIO MANAGER - Centralized sound system
  // ============================================
  class AudioManager {
    constructor() {
      this.sounds = {};
      this.currentWeatherSound = null;
      this.currentMusicSound = null;
      this.isInitialized = false;
      this.isMuted = false;
      this.activeSounds = [];
      this.maxSimultaneousSounds = 4;
      
      // Load settings from localStorage
      const savedSettings = this.loadSettings();
      this.volumes = {
        master: savedSettings.master !== undefined ? savedSettings.master : 1.0,
        music: savedSettings.music !== undefined ? savedSettings.music : 0.2,
        ambience: savedSettings.ambience !== undefined ? savedSettings.ambience : 0.3,
        sfx: savedSettings.sfx !== undefined ? savedSettings.sfx : 0.7,
      };
      this.reduceSoundMode = savedSettings.reduceSoundMode || false;
      
      // William avatar sound tracking
      this.williamLastEasterEgg = 0;
      this.williamClickCount = 0;
      this.williamClickTimestamps = [];
      this.williamSpamCooldown = false;
      
      // Sound manifest mapping
      this.soundMap = {
        // UI sounds
        'ui.click': ['ui/button-click-1', 'ui/button-click-2', 'ui/button-click-3'],
        'ui.hover': ['ui/hover-tick'],
        'ui.panelOpen': ['ui/panel-open'],
        'ui.panelClose': ['ui/panel-close'],
        'ui.toggleOn': ['ui/toggle-on'],
        'ui.toggleOff': ['ui/toggle-off'],
        'ui.tabChange': ['ui/tab-change'],
        'ui.success': ['ui/success-1', 'ui/success-2', 'ui/success-3'],
        'ui.error': ['ui/error-soft'],
        'ui.notification': ['ui/notification-ping'],
        
        // Avatar sounds
        'avatar.idle': ['avatar/idle-1', 'avatar/idle-2', 'avatar/idle-3'],
        'avatar.tap': ['avatar/william-tap'],
        'avatar.easterEgg': [
          'avatar/confetti-sneeze',
          'avatar/banana-slip',
          'avatar/bubble-burp',
          'avatar/pie-trap',
          'avatar/rubber-chicken',
          'avatar/hero-landing',
          'avatar/endless-scarf',
          'avatar/frog-crown',
          'avatar/chipmunk-voice',
          'avatar/marshmallow-volley',
          'avatar/hair-tornado',
          'avatar/tiger-shuffle',
          'avatar/lego-step',
          'avatar/goose-chase',
          'avatar/treasure-socks'
        ],
        'avatar.onBreak': ['avatar/william-on-break'],
        
        // Weather sounds
        'weather.sunny': ['weather/sunny-ambient'],
        'weather.cloudy': ['weather/cloudy-ambient'],
        'weather.rain': ['weather/rain-ambient'],
        'weather.storm': ['weather/storm-ambient'],
        'weather.snow': ['weather/snow-ambient'],
        
        // Music
        'music.hub': ['music/hub-loop'],
      };
    }
    
    // Initialize audio on user interaction (required for mobile)
    init() {
      if (this.isInitialized) return;
      this.isInitialized = true;
      console.log('AudioManager initialized');
      
      // Preload core UI sounds
      this.preloadSound('ui.click');
      this.preloadSound('ui.panelOpen');
      this.preloadSound('ui.panelClose');
      this.preloadSound('ui.toggleOn');
      this.preloadSound('ui.toggleOff');
      this.preloadSound('ui.success');
    }
    
    // Load settings from localStorage
    loadSettings() {
      try {
        const saved = localStorage.getItem('williamsWorldAudioSettings');
        return saved ? JSON.parse(saved) : {};
      } catch {
        return {};
      }
    }
    
    // Save settings to localStorage
    saveSettings() {
      const settings = {
        master: this.volumes.master,
        music: this.volumes.music,
        ambience: this.volumes.ambience,
        sfx: this.volumes.sfx,
        reduceSoundMode: this.reduceSoundMode,
      };
      localStorage.setItem('williamsWorldAudioSettings', JSON.stringify(settings));
    }
    
    // Get file path with extension
    getFilePath(key) {
      // Try OGG first (preferred), then WAV as fallback
      // This supports both production OGG files and development WAV placeholders
      return `audio/${key}.ogg`;  // Howler.js will handle format detection
    }
    
    // Preload a sound
    preloadSound(soundKey) {
      if (!this.soundMap[soundKey]) return;
      
      const files = this.soundMap[soundKey];
      files.forEach(file => {
        if (!this.sounds[file]) {
          // Placeholder: In production, would load actual Howler sound
          this.sounds[file] = {
            file: this.getFilePath(file),
            loaded: false,
          };
        }
      });
    }
    
    // Play a sound effect
    play(soundKey, options = {}) {
      if (this.isMuted || !this.isInitialized) return;
      
      // Get sound files for this key
      const files = this.soundMap[soundKey];
      if (!files || files.length === 0) {
        console.warn(`Sound not found: ${soundKey}`);
        return;
      }
      
      // Pick random variation
      const file = files[Math.floor(Math.random() * files.length)];
      
      // Determine volume based on category
      let volume = options.volume !== undefined ? options.volume : 1.0;
      if (soundKey.startsWith('ui.')) {
        volume *= this.volumes.sfx * this.volumes.master;
      } else if (soundKey.startsWith('avatar.')) {
        volume *= this.volumes.sfx * this.volumes.master;
        if (this.reduceSoundMode && soundKey === 'avatar.idle') {
          return; // Skip idle sounds in reduce mode
        }
      }
      
      // In production, would actually play the sound using Howler.js
      // For now, just log it
      console.log(`🔊 Playing: ${soundKey} (${file}) at volume ${volume.toFixed(2)}`);
      
      // Track active sound
      this.activeSounds.push({ key: soundKey, time: Date.now() });
      if (this.activeSounds.length > this.maxSimultaneousSounds) {
        this.activeSounds.shift();
      }
    }
    
    // Play weather ambient sound with crossfade
    playWeatherAmbience(weatherType) {
      if (this.isMuted || !this.isInitialized) return;
      
      const soundKey = `weather.${weatherType}`;
      if (!this.soundMap[soundKey]) return;
      
      const volume = this.volumes.ambience * this.volumes.master;
      
      // In production, would crossfade using Howler
      console.log(`🌤️ Weather ambience: ${soundKey} at volume ${volume.toFixed(2)}`);
      
      this.currentWeatherSound = soundKey;
    }
    
    // Stop weather ambience
    stopWeatherAmbience() {
      if (this.currentWeatherSound) {
        console.log(`🌤️ Stopping weather ambience: ${this.currentWeatherSound}`);
        this.currentWeatherSound = null;
      }
    }
    
    // Set volume for a category
    setVolume(category, value) {
      this.volumes[category] = Math.max(0, Math.min(1, value));
      this.saveSettings();
      
      // Update any playing sounds in that category
      if (category === 'ambience' && this.currentWeatherSound) {
        // Update weather sound volume
        console.log(`🔊 Updating ambience volume: ${value.toFixed(2)}`);
      }
      if (category === 'music' && this.currentMusicSound) {
        // Update music volume
        console.log(`🎵 Updating music volume: ${value.toFixed(2)}`);
      }
    }
    
    // Toggle mute
    toggleMute() {
      this.isMuted = !this.isMuted;
      if (this.isMuted) {
        // Stop all sounds
        this.stopWeatherAmbience();
        console.log('🔇 Audio muted');
      } else {
        console.log('🔊 Audio unmuted');
      }
      return this.isMuted;
    }
    
    // Set reduce sound mode
    setReduceSoundMode(enabled) {
      this.reduceSoundMode = enabled;
      this.saveSettings();
      console.log(`Reduce sound mode: ${enabled ? 'enabled' : 'disabled'}`);
    }
    
    // William avatar sound helpers
    canPlayWilliamEasterEgg() {
      const now = Date.now();
      
      // Check spam prevention
      this.williamClickTimestamps = this.williamClickTimestamps.filter(t => now - t < 3000);
      if (this.williamClickTimestamps.length >= 5) {
        if (!this.williamSpamCooldown) {
          this.williamSpamCooldown = true;
          this.play('avatar.onBreak');
          setTimeout(() => {
            this.williamSpamCooldown = false;
          }, 60000);
        }
        return false;
      }
      
      // Check rate limit
      if (now - this.williamLastEasterEgg < 1500) {
        return false;
      }
      
      return true;
    }
    
    playWilliamTap() {
      this.williamClickTimestamps.push(Date.now());
      this.play('avatar.tap');
    }
    
    playWilliamEasterEgg() {
      if (!this.canPlayWilliamEasterEgg()) return;
      
      this.williamLastEasterEgg = Date.now();
      this.play('avatar.easterEgg');
    }
    
    playWilliamIdle() {
      if (this.reduceSoundMode) return;
      this.play('avatar.idle');
    }
  }
  
  // Create global audio manager instance
  const audioManager = new AudioManager();

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) throw 0;
      const data = JSON.parse(raw);
      // Ensure companions exist
      if (!data.companions) {
        data.companions = {
          ember: { level: 3, xp: 0 },
          sprite: { level: 3, xp: 0 },
          golem: { level: 3, xp: 0 }
        };
      }
      // Ensure hp exists
      if (data.hp === undefined) data.hp = 100;
      // Ensure warChest exists
      if (data.warChest === undefined) data.warChest = 0;
      // Ensure morningMission exists
      if (!data.morningMission) {
        data.morningMission = {
          streak: 0,
          lastCompletionDate: null,
          dailyState: {} // date -> { status, completedTasks, completionBonus, startTime, endTime }
        };
      }
      return data;
    }catch{
      return { 
        xp:0, 
        level:1, 
        streak:0, 
        hp:100,
        warChest: 0,
        days:{},
        companions: {
          ember: { level: 3, xp: 0 },
          sprite: { level: 3, xp: 0 },
          golem: { level: 3, xp: 0 }
        },
        morningMission: {
          streak: 0,
          lastCompletionDate: null,
          dailyState: {}
        }
      };
    }
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function toast(msg){
    const el=$("toast"); el.textContent=msg; el.style.display="block";
    clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display="none", 2500);
  }
  
  // ============================================
  // MORNING MISSION STATE MANAGEMENT
  // ============================================
  
  // Get or create today's morning mission state
  function getTodayMissionState() {
    const today = getChicagoDateKey();
    if (!state.morningMission.dailyState[today]) {
      state.morningMission.dailyState[today] = {
        status: 'not_started',  // not_started, in_progress, completed, failed, expired
        completedTasks: {},      // taskId -> timestamp
        completionBonus: false,
        startTime: null,
        endTime: null
      };
    }
    return state.morningMission.dailyState[today];
  }
  
  // ============================================
  // GENERAL TASK ANTI-SPAM PROTECTION
  // ============================================
  
  // Track all task completions for the day (not just morning tasks)
  function getTodayTaskCompletions() {
    const today = todayKey();
    const day = state.days[today];
    if (!day.taskCompletions) {
      day.taskCompletions = {}; // taskId -> timestamp
    }
    return day.taskCompletions;
  }
  
  // Check if ANY task was already completed today (idempotent check)
  function isTaskCompletedToday(taskId) {
    const completions = getTodayTaskCompletions();
    return !!completions[taskId];
  }
  
  // Mark any task as completed for today (returns false if already completed)
  function markTaskCompletedToday(taskId) {
    const completions = getTodayTaskCompletions();
    
    // Anti-spam: already completed today
    if (completions[taskId]) {
      return false;
    }
    
    // Mark as completed
    completions[taskId] = Date.now();
    save();
    return true;
  }
  
  // Check if a specific morning task was completed today
  function isMorningTaskCompletedToday(taskId) {
    const missionState = getTodayMissionState();
    return !!missionState.completedTasks[taskId];
  }
  
  // Mark morning task as completed (returns false if already completed today)
  function markMorningTaskCompleted(taskId) {
    const missionState = getTodayMissionState();
    
    // Anti-spam: already completed today
    if (missionState.completedTasks[taskId]) {
      return false;
    }
    
    // Check time window
    if (!isInMorningWindow()) {
      return false;
    }
    
    // Mark as completed
    missionState.completedTasks[taskId] = Date.now();
    if (missionState.status === 'not_started') {
      missionState.status = 'in_progress';
      missionState.startTime = Date.now();
    }
    
    save();
    return true;
  }
  
  // Get count of completed morning tasks today
  function getMorningTasksCompletedCount() {
    const missionState = getTodayMissionState();
    return Object.keys(missionState.completedTasks).length;
  }
  
  // Check if all morning tasks are complete
  function areAllMorningTasksComplete() {
    const morningTaskIds = TASKS.filter(t => t.quest === 'morning').map(t => t.id);
    const missionState = getTodayMissionState();
    return morningTaskIds.every(id => missionState.completedTasks[id]);
  }
  
  // Complete the morning mission (all tasks done before deadline)
  function completeMorningMission() {
    const missionState = getTodayMissionState();
    
    if (missionState.status === 'completed' || missionState.completionBonus) {
      return; // Already completed
    }
    
    if (!areAllMorningTasksComplete()) {
      return; // Not all tasks complete
    }
    
    if (isMorningDeadlinePassed()) {
      return; // Too late
    }
    
    // Award completion bonus
    missionState.status = 'completed';
    missionState.completionBonus = true;
    missionState.endTime = Date.now();
    
    state.hp += MORNING_MISSION.HP_COMPLETION_BONUS;
    const maxHP = getMaxHP();
    if (state.hp > maxHP) state.hp = maxHP;
    
    // Update streak
    const today = getChicagoDateKey();
    const yesterday = getYesterdayDateKey();
    
    // Only update streak if this is genuinely a new completion (not same-day re-check)
    if (state.morningMission.lastCompletionDate === yesterday) {
      state.morningMission.streak += 1;
    } else if (state.morningMission.lastCompletionDate !== today) {
      // First completion or broken streak
      state.morningMission.streak = 1;
    }
    // If lastCompletionDate === today, keep streak unchanged (same-day completion check)
    
    state.morningMission.lastCompletionDate = today;
    
    // Streak bonus every 3 days
    if (state.morningMission.streak % MORNING_MISSION.STREAK_BONUS_INTERVAL === 0) {
      state.hp += MORNING_MISSION.STREAK_BONUS_HP;
      if (state.hp > maxHP) state.hp = maxHP;
      toast(`🎉 Mission Complete! +${MORNING_MISSION.HP_COMPLETION_BONUS} HP + Streak +${MORNING_MISSION.STREAK_BONUS_HP} HP!`);
    } else {
      toast(`🎉 Morning Mission Complete! +${MORNING_MISSION.HP_COMPLETION_BONUS} HP`);
    }
    
    save();
    updateMorningMissionUI();
    showMorningMissionSuccess();
  }
  
  // Fail the morning mission (deadline passed with incomplete tasks)
  function failMorningMission() {
    const missionState = getTodayMissionState();
    
    if (missionState.status === 'failed' || missionState.status === 'completed') {
      return; // Already processed
    }
    
    if (areAllMorningTasksComplete()) {
      return; // Actually completed
    }
    
    missionState.status = 'failed';
    missionState.endTime = Date.now();
    
    // Reset streak
    state.morningMission.streak = 0;
    
    save();
    updateMorningMissionUI();
    showMorningMissionFailed();
  }
  
  // Get yesterday's date key
  function getYesterdayDateKey() {
    const now = getChicagoTime();
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    return `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,"0")}-${String(yesterday.getDate()).padStart(2,"0")}`;
  }
  
  // Check and update morning mission status based on time
  function checkMorningMissionStatus() {
    const missionState = getTodayMissionState();
    
    if (missionState.status === 'completed' || missionState.status === 'failed') {
      return; // Already finalized
    }
    
    // Check if all tasks are complete
    if (areAllMorningTasksComplete() && !isMorningDeadlinePassed()) {
      completeMorningMission();
    } else if (isMorningDeadlinePassed() && !areAllMorningTasksComplete()) {
      failMorningMission();
    }
  }
  
  
  // Show floating XP animation
  function showFloatingXP(amount, x, y) {
    const el = document.createElement('div');
    el.className = 'floatingXP';
    el.textContent = `+${amount} XP`;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1500);
  }
  
  // Show companion reward card
  function showCompanionRewardCard(companion, newLevel) {
    const overlay = $('companionRewardOverlay');
    $('rewardEmoji').textContent = COMPANION_EMOJIS[companion];
    $('rewardCompName').textContent = COMPANION_NAMES[companion];
    $('rewardCompLevel').textContent = newLevel;
    $('rewardCompTitle').textContent = getCompanionTitle(companion, newLevel);
    overlay.classList.add('show');
    
    // Particle effects
    for (let i = 0; i < 25; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * window.innerWidth + 'px';
        particle.style.top = Math.random() * window.innerHeight + 'px';
        const colors = ['var(--gold)', 'var(--green)', 'var(--blue)', '#ff6b8a', '#c084fc'];
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        overlay.querySelector('.content').appendChild(particle);
        setTimeout(() => particle.remove(), 2000);
      }, i * 40);
    }
    
    setTimeout(() => overlay.classList.remove('show'), 3000);
  }

  // Show level-down overlay
  function showLevelDown(newLevel) {
    const overlay = $('levelDownOverlay');
    $('levelDownNumber').textContent = newLevel;
    $('levelDownTitle').textContent = getLevelTitle(newLevel);
    overlay.classList.add('show');
    setTimeout(() => overlay.classList.remove('show'), 3000);
  }

  // Check for level down when HP reaches 0
  function checkLevelDown() {
    if (state.hp <= 0 && state.level > 1) {
      state.level = Math.max(1, state.level - 1);
      state.xp = 0;
      state.hp = LEVEL_DOWN_HP_RESET;
      save();
      showLevelDown(state.level);
      toast(`💀 LEVEL DOWN! Dropped to Level ${state.level}: ${getLevelTitle(state.level)}`);
    }
  }
  function showLevelUpCelebration(level) {
    const overlay = $('levelUpOverlay');
    const levelNum = $('levelUpNumber');
    const levelTitle = $('levelUpTitle');
    const williamImgOverlay = $('williamImgOverlay');
    
    levelNum.textContent = level;
    levelTitle.textContent = getLevelTitle(level);
    if (williamImgOverlay) williamImgOverlay.src = getWilliamImage(level);
    overlay.classList.add('show');
    
    // Create particle effects
    for (let i = 0; i < 30; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * window.innerWidth + 'px';
        particle.style.top = Math.random() * window.innerHeight + 'px';
        overlay.querySelector('.content').appendChild(particle);
        setTimeout(() => particle.remove(), 2000);
      }, i * 50);
    }
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
      overlay.classList.remove('show');
    }, 3000);
  }
  
  // ============================================
  // MORNING MISSION UI FUNCTIONS
  // ============================================
  
  // Update Morning Mission UI
  function updateMorningMissionUI() {
    const questCard = $('questMorning');
    if (!questCard) return;
    
    const missionState = getTodayMissionState();
    const morningTaskIds = TASKS.filter(t => t.quest === 'morning').map(t => t.id);
    const completedCount = getMorningTasksCompletedCount();
    const totalCount = morningTaskIds.length;
    
    // Update timer and status banner
    let timerEl = questCard.querySelector('.missionTimer');
    let statusBanner = questCard.querySelector('.missionStatusBanner');
    let bombVisual = questCard.querySelector('.bombVisual');
    
    // Create elements if they don't exist
    if (!timerEl) {
      timerEl = document.createElement('div');
      timerEl.className = 'missionTimer';
      questCard.insertBefore(timerEl, questCard.querySelector('.questChecklist'));
    }
    
    if (!statusBanner) {
      statusBanner = document.createElement('div');
      statusBanner.className = 'missionStatusBanner';
      questCard.insertBefore(statusBanner, questCard.querySelector('.questChecklist'));
    }
    
    if (!bombVisual) {
      bombVisual = document.createElement('div');
      bombVisual.className = 'bombVisual';
      questCard.insertBefore(bombVisual, questCard.querySelector('.questChecklist'));
    }
    
    // Update based on status
    if (missionState.status === 'completed') {
      timerEl.style.display = 'none';
      statusBanner.style.display = 'block';
      statusBanner.className = 'missionStatusBanner success';
      statusBanner.textContent = '🎉 Morning Mission Complete!';
      bombVisual.innerHTML = '<div class="bombDisarmed">💚 DISARMED</div>';
      bombVisual.className = 'bombVisual disarmed';
    } else if (missionState.status === 'failed') {
      timerEl.style.display = 'none';
      statusBanner.style.display = 'block';
      statusBanner.className = 'missionStatusBanner failed';
      const missedTasks = morningTaskIds.filter(id => !missionState.completedTasks[id])
        .map(id => TASKS.find(t => t.id === id).label.replace('Morning: ', ''))
        .join(', ');
      statusBanner.innerHTML = `💥 Morning Mission Failed<br><span class="small">You missed: ${missedTasks}</span>`;
      bombVisual.innerHTML = '<div class="bombExploded">💥 BOOM!</div>';
      bombVisual.className = 'bombVisual exploded';
    } else if (isBeforeMorningWindow()) {
      timerEl.style.display = 'block';
      timerEl.className = 'missionTimer locked';
      timerEl.textContent = '🔒 Opens at 6:00 AM';
      statusBanner.style.display = 'none';
      updateBombWires(bombVisual, completedCount, totalCount);
    } else if (isMorningDeadlinePassed()) {
      // Deadline passed, check status
      checkMorningMissionStatus();
    } else if (isInMorningWindow()) {
      // Active mission
      timerEl.style.display = 'block';
      const remaining = getTimeUntilDeadline();
      const formatted = formatTimeRemaining(remaining);
      
      // Color based on urgency
      let urgency = 'normal';
      if (remaining < 2 * 60 * 1000) urgency = 'critical'; // < 2 minutes
      else if (remaining < 10 * 60 * 1000) urgency = 'warning'; // < 10 minutes
      
      timerEl.className = `missionTimer active ${urgency}`;
      timerEl.innerHTML = `⏱️ Time Left: <strong>${formatted}</strong><br><span class="deadline">Mission ends at ${MORNING_MISSION.DEADLINE_HOUR}:00 AM</span>`;
      statusBanner.style.display = 'none';
      updateBombWires(bombVisual, completedCount, totalCount);
    } else {
      timerEl.style.display = 'none';
      statusBanner.style.display = 'none';
      updateBombWires(bombVisual, completedCount, totalCount);
    }
    
    // Update wire colors on task items
    morningTaskIds.forEach(taskId => {
      const checkItem = document.querySelector(`.checkItem[data-task="${taskId}"]`);
      if (!checkItem) return;
      
      const wireColor = MORNING_MISSION.WIRE_COLORS[taskId];
      if (!wireColor) return;
      
      let wireBadge = checkItem.querySelector('.wireBadge');
      if (!wireBadge) {
        wireBadge = document.createElement('span');
        wireBadge.className = 'wireBadge';
        checkItem.insertBefore(wireBadge, checkItem.querySelector('span'));
      }
      
      wireBadge.textContent = wireColor.icon;
      wireBadge.style.background = wireColor.color;
      wireBadge.title = `${wireColor.label} wire`;
      
      if (isMorningTaskCompletedToday(taskId)) {
        wireBadge.classList.add('cut');
      } else {
        wireBadge.classList.remove('cut');
      }
    });
  }
  
  // Update bomb visual with wires
  function updateBombWires(bombVisual, completedCount, totalCount) {
    if (!bombVisual) return;
    
    bombVisual.className = 'bombVisual active';
    bombVisual.innerHTML = '';
    
    const morningTaskIds = TASKS.filter(t => t.quest === 'morning').map(t => t.id);
    const missionState = getTodayMissionState();
    
    // Progress indicator
    const progress = document.createElement('div');
    progress.className = 'bombProgress';
    progress.innerHTML = `<strong>Wires Cut: ${completedCount}/${totalCount}</strong>`;
    bombVisual.appendChild(progress);
    
    // Bomb emoji
    const bomb = document.createElement('div');
    bomb.className = 'bombEmoji';
    bomb.textContent = '💣';
    bombVisual.appendChild(bomb);
    
    // Wires
    const wiresContainer = document.createElement('div');
    wiresContainer.className = 'wiresContainer';
    
    morningTaskIds.forEach(taskId => {
      const wireInfo = MORNING_MISSION.WIRE_COLORS[taskId];
      if (!wireInfo) return;
      
      const wire = document.createElement('div');
      wire.className = 'wire';
      if (missionState.completedTasks[taskId]) {
        wire.classList.add('cut');
      }
      wire.style.background = wireInfo.color;
      wire.title = `${wireInfo.label} wire - ${TASKS.find(t => t.id === taskId).label.replace('Morning: ', '')}`;
      
      wiresContainer.appendChild(wire);
    });
    
    bombVisual.appendChild(wiresContainer);
  }
  
  // Show mission success animation
  function showMorningMissionSuccess() {
    const overlay = document.createElement('div');
    overlay.className = 'missionOverlay success';
    overlay.innerHTML = `
      <div class="missionOverlayContent">
        <div class="williamHero">🦸</div>
        <h2>Morning Mission Complete!</h2>
        <div class="missionStats">
          <div>✅ All tasks complete before deadline</div>
          <div>💚 +${MORNING_MISSION.HP_COMPLETION_BONUS} HP Bonus</div>
          <div>🔥 Streak: ${state.morningMission.streak} days</div>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // Confetti effect
    for (let i = 0; i < MORNING_MISSION.CONFETTI_COUNT; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        const colors = ['#ffd36e', '#7dffb4', '#ff9d5c', '#d4a530', '#7c3aed'];
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        overlay.querySelector('.missionOverlayContent').appendChild(confetti);
      }, i * 20);
    }
    
    setTimeout(() => {
      overlay.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      overlay.classList.remove('show');
      setTimeout(() => overlay.remove(), MORNING_MISSION.OVERLAY_FADE_DURATION);
    }, 3500);
  }
  
  // Show mission failed animation
  function showMorningMissionFailed() {
    const overlay = document.createElement('div');
    overlay.className = 'missionOverlay failed';
    
    const morningTaskIds = TASKS.filter(t => t.quest === 'morning').map(t => t.id);
    const missionState = getTodayMissionState();
    const missedTasks = morningTaskIds.filter(id => !missionState.completedTasks[id])
      .map(id => TASKS.find(t => t.id === id).label.replace('Morning: ', ''));
    
    overlay.innerHTML = `
      <div class="missionOverlayContent">
        <div class="williamSooty">😅💨</div>
        <h2>Morning Mission Failed</h2>
        <div class="missionStats">
          <div>⏰ Deadline passed at ${MORNING_MISSION.DEADLINE_HOUR}:00 AM</div>
          <div>📋 You missed: ${missedTasks.join(', ')}</div>
          <div>🔄 Try again tomorrow!</div>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // Smoke puffs
    for (let i = 0; i < MORNING_MISSION.SMOKE_PUFF_COUNT; i++) {
      setTimeout(() => {
        const smoke = document.createElement('div');
        smoke.className = 'smoke';
        smoke.textContent = '💨';
        smoke.style.left = 45 + Math.random() * 10 + '%';
        smoke.style.animationDelay = Math.random() * 0.3 + 's';
        overlay.querySelector('.missionOverlayContent').appendChild(smoke);
      }, i * 100);
    }
    
    setTimeout(() => {
      overlay.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      overlay.classList.remove('show');
      setTimeout(() => overlay.remove(), MORNING_MISSION.OVERLAY_FADE_DURATION);
    }, 4000);
  }

  function applyAssets(){
    const bannerEl = document.querySelector("#ww [data-banner]");
    // Banner background removed - letting the cinematic backdrop show through
    const logoImg = $("logoImg");
    const mapstripImg = $("mapstripImg");
    const emberImg = $("emberImg");
    const spriteImg = $("spriteImg");
    const golemImg = $("golemImg");
    
    if(logoImg) logoImg.src = ASSETS.logo;
    if(mapstripImg) mapstripImg.src = ASSETS.mapstrip;
    if(emberImg) emberImg.src = ASSETS.companions.ember;
    if(spriteImg) spriteImg.src = ASSETS.companions.sprite;
    if(golemImg) golemImg.src = ASSETS.companions.golem;
    
    // Load William's character image
    const williamImg = $("williamImg");
    if(williamImg) williamImg.src = getWilliamImage(state.level);
    
    // Load zone images
    if($("zone1Img")) $("zone1Img").src = ASSETS.zones.z1;
    if($("zone2Img")) $("zone2Img").src = ASSETS.zones.z2;
    if($("zone3Img")) $("zone3Img").src = ASSETS.zones.z3;
    if($("zone4Img")) $("zone4Img").src = ASSETS.zones.z4;
    
    // Load zone icon images in sidebar
    if($("zone1IconImg")) $("zone1IconImg").src = ASSETS.zones.z1;
    if($("zone2IconImg")) $("zone2IconImg").src = ASSETS.zones.z2;
    if($("zone3IconImg")) $("zone3IconImg").src = ASSETS.zones.z3;
    if($("zone4IconImg")) $("zone4IconImg").src = ASSETS.zones.z4;
  }

  let state = load();
  const TODAY = todayKey();
  function getMaxHP() { return 100 + (state.streak * HP_PER_STREAK); }
  if(!state.days[TODAY]){
    state.days[TODAY]={ 
      tasks:Object.fromEntries(TASKS.map(t=>[t.id,false])), 
      result:"Not graded",
      taskCompletions: {} // Track task completion timestamps for anti-spam
    };
    save();
  }
  // Ensure taskCompletions exists for existing days
  if (!state.days[TODAY].taskCompletions) {
    state.days[TODAY].taskCompletions = {};
  }

  // Calculate damage for incomplete tasks in a day
  function calcDamage(dayData) {
    let dmg = 0;
    TASKS.forEach(t => {
      if (!dayData.tasks[t.id]) dmg += t.xp;
    });
    return dmg;
  }

  // Midnight check: auto-grade any past ungraded days as FAIL and apply damage
  function midnightCheck() {
    let totalDamage = 0;
    const sortedKeys = Object.keys(state.days).sort();
    sortedKeys.forEach(dateKey => {
      if (dateKey >= TODAY) return; // skip today
      const day = state.days[dateKey];
      if (day.result === "Not graded") {
        // Midnight passed without grading — auto-FAIL and apply damage
        day.result = "FAIL";
        const dmg = calcDamage(day);
        totalDamage += dmg;
        state.streak = 0;
      }
    });
    if (totalDamage > 0) {
      state.hp = Math.max(0, state.hp - totalDamage);
      // Cap HP to max based on current streak
      const maxHP = getMaxHP();
      if (state.hp > maxHP) state.hp = maxHP;
      save();
      setTimeout(() => {
        toast(`💀 Midnight damage! -${totalDamage} HP for missed tasks`);
        checkLevelDown();
      }, 500);
    }
  }
  midnightCheck();

  function isPassDay(){
    const day = state.days[TODAY];
    // PASS criteria: all three quest categories must be complete
    // Night quest task IDs
    const nightIds = ["n_trapper","n_clothes","n_lunch","n_shoes"];
    // Morning quest task IDs
    const morningIds = ["m_prayer","m_dressed","m_teeth","m_trappercheck"];
    // Backpack/Trapper quest task IDs
    const backpackIds = ["t_work","t_notebooks","t_supplies","t_check"];
    
    const nightOk = nightIds.every(id=>day.tasks[id]===true);
    const morningOk = morningIds.every(id=>day.tasks[id]===true);
    const backpackOk = backpackIds.every(id=>day.tasks[id]===true);
    
    return nightOk && morningOk && backpackOk;
  }

  function recalcLevel(){
    let leveledUp = false;
    let newLevel = state.level;
    while(state.xp >= xpForLevel(state.level)){
      state.xp -= xpForLevel(state.level);
      state.level += 1;
      newLevel = state.level;
      leveledUp = true;
    }
    if (leveledUp) {
      showLevelUpCelebration(newLevel);
      toast(`LEVEL UP → ${newLevel}: ${getLevelTitle(newLevel)}`);
    }
  }
  
  // Add XP to companions
  function addCompanionXP(amount, specificComp) {
    const comps = specificComp ? [specificComp] : COMPANIONS;
    comps.forEach(comp => {
      const prevLevel = state.companions[comp].level;
      state.companions[comp].xp += Math.floor(amount);
      // Companions level up every 100 XP
      while (state.companions[comp].xp >= COMPANION_XP_PER_LEVEL) {
        state.companions[comp].xp -= COMPANION_XP_PER_LEVEL;
        state.companions[comp].level += 1;
      }
      if (state.companions[comp].level > prevLevel) {
        showCompanionRewardCard(comp, state.companions[comp].level);
      }
    });
  }

  function updateHeader(){
    $("todayLabel").textContent = prettyToday();
    $("levelNum").textContent = state.level;
    $("levelTitle").textContent = getLevelTitle(state.level);
    $("streakNum").textContent = state.streak;

    const need = xpForLevel(state.level);
    $("xpNow").textContent = state.xp;
    $("xpNext").textContent = need;
    $("xpBar").style.width = Math.max(0, Math.min(100, Math.round((state.xp/need)*100))) + "%";

    $("dayResult").textContent = state.days[TODAY].result;
    
    // Update William's character image based on level
    const williamImg = $("williamImg");
    if (williamImg) williamImg.src = getWilliamImage(state.level);
    
    // Update HP display
    const maxHP = getMaxHP();
    const hpPct = Math.max(0, Math.min(100, Math.round((state.hp / maxHP) * 100)));
    $("hpNum").textContent = state.hp;
    $("hpMaxPill").textContent = maxHP;
    $("hpNow").textContent = state.hp;
    $("hpMax").textContent = maxHP;
    $("hpBar").style.width = hpPct + "%";
    $("dashHP").textContent = state.hp;
    $("dashHPMax").textContent = maxHP;
    $("dashHPBar").style.width = hpPct + "%";
    
    // Low HP warning
    const hpMeterBanner = $("hpMeterBanner");
    const hpMeterDash = $("hpMeterDash");
    if (hpPct <= 25) {
      if (hpMeterBanner) hpMeterBanner.classList.add("low");
      if (hpMeterDash) hpMeterDash.classList.add("low");
    } else {
      if (hpMeterBanner) hpMeterBanner.classList.remove("low");
      if (hpMeterDash) hpMeterDash.classList.remove("low");
    }

    // Update dashboard
    $("dashXP").textContent = state.xp;
    $("dashStreak").textContent = state.streak;
    $("dashXPBar").style.width = Math.max(0, Math.min(100, Math.round((state.xp/need)*100))) + "%";
    
    // Update streak fire animation
    const streakFire = document.querySelector('.streakFire');
    if (streakFire) {
      if (state.streak >= 10) {
        streakFire.classList.add('mega');
      } else {
        streakFire.classList.remove('mega');
      }
    }
    
    updateBadges();
    updateStreakBadges();
    updateWeeklyTracker();
    updateCompanions();
    updateZones();
    
    // Update War Chest display
    const warChestGold = $("warChestGold");
    if (warChestGold) warChestGold.textContent = state.warChest;
    document.querySelectorAll('.awardBtn').forEach(btn => {
      btn.disabled = state.warChest < WAR_CHEST_AWARD_COST;
    });
  }
  
  // Update companion display
  function updateCompanions() {
    COMPANIONS.forEach(comp => {
      const el = $(`companion${comp.charAt(0).toUpperCase() + comp.slice(1)}`);
      if (!el) return;
      
      const compData = state.companions[comp];
      el.querySelector('.companionLevel').textContent = compData.level;
      el.querySelector('.companionXPBar').style.width = (compData.xp % 100) + '%';
      
      // Update companion title
      const titleEl = $(`${comp}Title`);
      if (titleEl) titleEl.textContent = getCompanionTitle(comp, compData.level);
      
      // Add evolved class for higher level companions
      if (compData.level >= 5) {
        el.classList.add('evolved');
      } else {
        el.classList.remove('evolved');
      }
    });
  }
  
  // Update zone unlocking based on cumulative PASS days
  function updateZones() {
    const passCount = Object.values(state.days).filter(d => d.result === 'PASS').length;
    
    MAP.forEach((zone, idx) => {
      const zoneEl = $(zone.id.replace('z', 'zone'));
      if (!zoneEl) return;
      
      const isUnlocked = passCount >= zone.need;
      const statusEl = zoneEl.querySelector('.zoneStatus');
      const lockIcon = zoneEl.querySelector('.lockIcon');
      
      if (isUnlocked) {
        zoneEl.classList.remove('locked');
        zoneEl.classList.add('unlocked');
        if (statusEl) {
          statusEl.classList.remove('locked');
          statusEl.classList.add('unlocked');
          statusEl.textContent = '✓ UNLOCKED!';
        }
        if (lockIcon) lockIcon.style.display = 'none';
      } else {
        zoneEl.classList.add('locked');
        zoneEl.classList.remove('unlocked');
        if (statusEl) {
          statusEl.classList.add('locked');
          statusEl.classList.remove('unlocked');
          statusEl.textContent = `🔒 Unlocks at ${zone.need} day${zone.need > 1 ? 's' : ''}`;
        }
        if (lockIcon) lockIcon.style.display = 'block';
      }
    });
  }
  
  // Update streak milestone badges
  function updateStreakBadges() {
    const milestones = [
      { days: 3, id: 'streakBadge3' },
      { days: 5, id: 'streakBadge5' },
      { days: 7, id: 'streakBadge7' },
      { days: 10, id: 'streakBadge10' }
    ];
    
    milestones.forEach(m => {
      const badge = $(m.id);
      if (!badge) return;
      
      if (state.streak >= m.days) {
        badge.classList.add('earned');
        badge.classList.remove('locked');
      } else {
        badge.classList.add('locked');
        badge.classList.remove('earned');
      }
    });
    
    // Update next badge text
    if (state.streak < 3) $("nextBadge").textContent = "Bronze Shield (3 days)";
    else if (state.streak < 5) $("nextBadge").textContent = "Silver Sword (5 days)";
    else if (state.streak < 7) $("nextBadge").textContent = "Gold Crown (7 days)";
    else if (state.streak < 10) $("nextBadge").textContent = "Diamond Dragon (10 days)";
    else $("nextBadge").textContent = "All Milestones Earned! 🎉";
  }
  
  function updateBadges(){
    const day = state.days[TODAY];
    
    // Badge 1: Trapper Master (all backpack tasks complete)
    const backpackIds = ["t_work","t_notebooks","t_supplies","t_check"];
    const trapperMaster = backpackIds.every(id=>day.tasks[id]===true);
    const b1 = $("badge1");
    if(trapperMaster){ b1.classList.add("earned"); b1.classList.remove("locked"); }
    else{ b1.classList.add("locked"); b1.classList.remove("earned"); }
    
    // Badge 2: Perfect Day (all tasks complete)
    const perfectDay = TASKS.every(t=>day.tasks[t.id]===true);
    const b2 = $("badge2");
    if(perfectDay){ b2.classList.add("earned"); b2.classList.remove("locked"); }
    else{ b2.classList.add("locked"); b2.classList.remove("earned"); }
    
    // Badge 3: Streak Star (3+ day streak)
    const b3 = $("badge3");
    if(state.streak >= 3){ b3.classList.add("earned"); b3.classList.remove("locked"); }
    else{ b3.classList.add("locked"); b3.classList.remove("earned"); }
    
    // Badge 4: No Missing Items (morning backpack check complete)
    const noMissing = day.tasks["m_trappercheck"] === true;
    const b4 = $("badge4");
    if(noMissing){ b4.classList.add("earned"); b4.classList.remove("locked"); }
    else{ b4.classList.add("locked"); b4.classList.remove("earned"); }
    
    // Update next badge text
    if(!trapperMaster) $("nextBadge").textContent = "Trapper Master";
    else if(!noMissing) $("nextBadge").textContent = "No Missing Items";
    else if(!perfectDay) $("nextBadge").textContent = "Perfect Day";
    else if(state.streak < 3) $("nextBadge").textContent = "Streak Star";
    else $("nextBadge").textContent = "All Earned! 🎉";
  }
  
  function updateWeeklyTracker(){
    // Get current week's days (Mon-Fri)
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
    
    // Calculate dates for Mon-Fri of current week
    const weekDays = ["mon","tue","wed","thu","fri"];
    weekDays.forEach((dayName, idx) => {
      const dayBox = document.querySelector(`[data-day="${dayName}"]`);
      if(!dayBox) return;
      
      // Calculate date for this day (Mon=1, Tue=2, ..., Fri=5)
      const targetDay = idx + 1;
      const diff = targetDay - dayOfWeek;
      const date = new Date(today);
      date.setDate(date.getDate() + diff);
      const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
      
      // Check if this day is PASS
      if(state.days[dateKey] && state.days[dateKey].result === "PASS"){
        dayBox.classList.add("complete");
      } else {
        dayBox.classList.remove("complete");
      }
    });
  }

  function renderTasks(){
    const day = state.days[TODAY];
    const list = $("taskList");
    list.innerHTML = "";
    TASKS.forEach(t=>{
      const row=document.createElement("div");
      row.className="task";
      row.innerHTML = `
        <input type="checkbox" ${day.tasks[t.id]?"checked":""}>
        <div class="name"></div>
        <div class="xp">+${t.xp} XP</div>
      `;
      row.querySelector(".name").textContent = t.label;

      const cb=row.querySelector("input");
      cb.addEventListener("change", ()=>{
        const was = day.tasks[t.id]===true;
        day.tasks[t.id] = cb.checked;

        if(!was && cb.checked){ 
          state.xp += t.xp; 
          addCompanionXP(t.xp / 3); // Companions get 1/3 of player XP
          state.warChest += Math.floor(t.xp * WAR_CHEST_XP_RATE);
          recalcLevel(); 
          toast(`+${t.xp} XP`); 
        }
        day.result="Not graded";
        save();
        updateHeader();
        syncQuestCheckboxes();
      });

      list.appendChild(row);
    });
  }
  
  // Setup quest card checkboxes
  function setupQuestCheckboxes() {
    const day = state.days[TODAY];
    
    // For each task, find its checkbox in the quest cards
    TASKS.forEach(task => {
      const checkItem = document.querySelector(`.checkItem[data-task="${task.id}"]`);
      if (!checkItem) return;
      
      const checkbox = checkItem.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      // Set initial state
      checkbox.checked = day.tasks[task.id] === true;
      if (checkbox.checked) {
        checkItem.classList.add('completed');
      }
      
      // Add change handler
      checkbox.addEventListener('change', (e) => {
        const wasChecked = day.tasks[task.id] === true;
        
        // UNIVERSAL ANTI-SPAM PROTECTION FOR ALL TASKS
        // Check if already completed today (prevents check/uncheck/check exploit)
        if (checkbox.checked && isTaskCompletedToday(task.id)) {
          toast("Already done today ✅");
          checkbox.checked = true; // Keep checked
          return;
        }
        
        // MORNING MISSION-SPECIFIC TIME WINDOW CHECK
        if (task.quest === 'morning' && checkbox.checked && !wasChecked) {
          if (isBeforeMorningWindow()) {
            toast(getMissionWindowString());
            checkbox.checked = false;
            return;
          }
          if (isMorningDeadlinePassed()) {
            toast("Morning Mission closed. Try again tomorrow.");
            checkbox.checked = false;
            return;
          }
          if (!isInMorningWindow()) {
            toast(getMissionWindowString());
            checkbox.checked = false;
            return;
          }
        }
        
        day.tasks[task.id] = checkbox.checked;
        
        if (!wasChecked && checkbox.checked) {
          // Mark task as completed for today (anti-spam)
          const completedNow = markTaskCompletedToday(task.id);
          if (!completedNow) {
            // Should not happen due to check above, but safety check
            toast("Already done today ✅");
            return;
          }
          
          // Task just completed - award rewards
          let hpAwarded = 0;
          
          // Morning task HP rewards
          if (task.quest === 'morning') {
            const success = markMorningTaskCompleted(task.id);
            if (success) {
              hpAwarded = MORNING_MISSION.HP_PER_TASK;
              state.hp += hpAwarded;
              const maxHP = getMaxHP();
              if (state.hp > maxHP) state.hp = maxHP;
            }
          }
          
          state.xp += task.xp;
          addCompanionXP(task.xp / 3); // Companions get 1/3 of player XP
          state.warChest += Math.floor(task.xp * WAR_CHEST_XP_RATE);
          recalcLevel();
          
          // Show floating XP animation
          const rect = checkItem.getBoundingClientRect();
          showFloatingXP(task.xp, rect.left + rect.width / 2, rect.top);
          
          // Toast with HP if morning task
          if (hpAwarded > 0) {
            toast(`+${task.xp} XP + ${hpAwarded} HP! ❤️`);
            // Check if mission complete
            checkMorningMissionStatus();
            updateMorningMissionUI();
          } else {
            toast(`+${task.xp} XP Earned!`);
          }
          
          checkItem.classList.add('completed');
        } else if (wasChecked && !checkbox.checked) {
          // Task unchecked - do NOT remove completion flag (idempotent)
          // User can uncheck visually, but won't get rewards again
          checkItem.classList.remove('completed');
        }
        
        day.result = "Not graded";
        save();
        updateHeader();
        updateQuestProgress(task.quest);
        renderTasks(); // Keep backward compat task list in sync
      });
    });
    
    // Initialize progress bars for all quests
    ['night', 'morning', 'backpack'].forEach(questType => {
      updateQuestProgress(questType);
    });
    
    // Initialize Morning Mission UI
    updateMorningMissionUI();
  }
  
  // Sync quest checkboxes with state (called from renderTasks)
  function syncQuestCheckboxes() {
    const day = state.days[TODAY];
    TASKS.forEach(task => {
      const checkItem = document.querySelector(`.checkItem[data-task="${task.id}"]`);
      if (!checkItem) return;
      
      const checkbox = checkItem.querySelector('input[type="checkbox"]');
      if (!checkbox) return;
      
      checkbox.checked = day.tasks[task.id] === true;
      if (checkbox.checked) {
        checkItem.classList.add('completed');
      } else {
        checkItem.classList.remove('completed');
      }
    });
    
    // Update progress bars
    ['night', 'morning', 'backpack'].forEach(questType => {
      updateQuestProgress(questType);
    });
  }
  
  // Update quest progress bar
  function updateQuestProgress(questType) {
    const day = state.days[TODAY];
    const questTasks = TASKS.filter(t => t.quest === questType);
    const completedCount = questTasks.filter(t => day.tasks[t.id] === true).length;
    const totalCount = questTasks.length;
    const percentage = (completedCount / totalCount) * 100;
    
    // Find the quest card
    const cardId = questType === 'night' ? 'questNight' : 
                   questType === 'morning' ? 'questMorning' : 'questBackpack';
    const card = $(cardId);
    if (!card) return;
    
    const progressText = card.querySelector('.progressText');
    const progressBar = card.querySelector('.progressBar');
    
    if (progressText) {
      progressText.textContent = `${completedCount}/${totalCount} tasks`;
    }
    if (progressBar) {
      progressBar.style.width = percentage + '%';
    }
    
    // Show quest complete celebration
    if (completedCount === totalCount && completedCount > 0) {
      // Check if we just completed it (to avoid showing multiple times)
      if (!card.dataset.celebrated) {
        card.dataset.celebrated = 'true';
        toast(`🎉 ${questType.toUpperCase()} QUEST COMPLETE!`);
      }
    } else {
      delete card.dataset.celebrated;
    }
  }

  function gradeDay(){
    const pass = isPassDay();
    state.days[TODAY].result = pass ? "PASS" : "FAIL";
    state.streak = pass ? (state.streak+1) : 0;
    if (!pass) {
      const dmg = calcDamage(state.days[TODAY]);
      state.hp = Math.max(0, state.hp - dmg);
    }
    // Cap HP to new max (streak may have changed)
    const maxHP = getMaxHP();
    if (state.hp > maxHP) state.hp = maxHP;
    save();
    updateHeader();
    toast(pass ? "🎉 PASS! Streak +1" : `⚠️ FAIL. Streak reset. -${calcDamage(state.days[TODAY])} HP!`);
    if (!pass) checkLevelDown();
  }

  document.querySelectorAll("#ww .nav button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      initAudioOnInteraction();
      audioManager.play('ui.click');
      document.querySelectorAll("#ww .nav button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.section;
      const target = document.getElementById(id);
      if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });

  // Add grading and reset buttons to topbar actions
  const topbar = document.querySelector(".topbar-inner .nav");
  if(topbar){
    const gradeBtn = document.createElement("button");
    gradeBtn.textContent = "🏆 Grade";
    gradeBtn.setAttribute("aria-label", "Grade today's progress and update streak");
    gradeBtn.addEventListener("click", () => {
      initAudioOnInteraction();
      const pass = isPassDay();
      if (pass) {
        audioManager.play('ui.success');
      } else {
        audioManager.play('ui.error');
      }
      gradeDay();
    });
    topbar.appendChild(gradeBtn);
    
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "🧽 Reset";
    resetBtn.setAttribute("aria-label", "Reset today's task completion");
    resetBtn.addEventListener("click", ()=>{
      initAudioOnInteraction();
      audioManager.play('ui.click');
      state.days[TODAY]={ tasks:Object.fromEntries(TASKS.map(t=>[t.id,false])), result:"Not graded" };
      save(); 
      renderTasks(); 
      setupQuestCheckboxes();
      updateHeader(); 
      toast("Today reset");
    });
    topbar.appendChild(resetBtn);
  }

  // War Chest Award button handlers
  document.querySelectorAll('.awardBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      initAudioOnInteraction();
      const comp = btn.dataset.award;
      if (state.warChest < WAR_CHEST_AWARD_COST) {
        audioManager.play('ui.error');
        toast('Not enough gold in the War Chest!');
        return;
      }
      audioManager.play('ui.success');
      state.warChest -= WAR_CHEST_AWARD_COST;
      addCompanionXP(WAR_CHEST_AWARD_COST, comp);
      save();
      updateHeader();
      toast(`🪙 Awarded ${WAR_CHEST_AWARD_COST} gold to ${COMPANION_NAMES[comp]}!`);
    });
  });

  // William Character Animation System
  const williamAnimations = [
    'william-jump',
    'william-spin',
    'william-shake',
    'william-flip',
    'william-wave',
    'william-pulse-glow',
    'william-bounce-rotate',
    'william-swing',
    'william-zoom',
    'william-slide',
    'william-wobble',
    'william-float-spin',
    'william-bounce-scale',
    'william-rainbow',
    'william-victory',
    // Fun animations for kids!
    'william-fire',
    'william-fart',
    'william-throw',
    'william-burp',
    'william-sneeze',
    'william-dizzy',
    'william-dance',
    'william-explode',
    // New skills!
    'william-water-balloon',
    'william-slip-out'
  ];

  function applyRandomWilliamAnimation() {
    const williamAvatar = document.getElementById('williamAvatar');
    if (!williamAvatar) return;

    // Play idle sound
    audioManager.playWilliamIdle();

    // Remove any existing animation
    williamAvatar.style.animation = 'none';
    
    // Force browser reflow to restart animation from beginning
    // This is a standard technique to retrigger CSS animations
    void williamAvatar.offsetWidth;
    
    // Pick a random animation
    const randomAnimation = williamAnimations[Math.floor(Math.random() * williamAnimations.length)];
    
    // Apply the animation (2 seconds duration)
    williamAvatar.style.animation = `${randomAnimation} 2s ease-in-out`;
    
    // Add particle effects for fun animations
    if (randomAnimation === 'william-fire') {
      createFireEffect(williamAvatar);
    } else if (randomAnimation === 'william-fart') {
      createFartEffect(williamAvatar);
    } else if (randomAnimation === 'william-throw') {
      createThrowEffect(williamAvatar);
    } else if (randomAnimation === 'william-burp') {
      createBurpEffect(williamAvatar);
    } else if (randomAnimation === 'william-sneeze') {
      createSneezeEffect(williamAvatar);
    } else if (randomAnimation === 'william-explode') {
      createExplodeEffect(williamAvatar);
    } else if (randomAnimation === 'william-water-balloon') {
      createWaterBalloonEffect(williamAvatar);
    } else if (randomAnimation === 'william-slip-out') {
      createSlipOutEffect(williamAvatar);
    }
    
    // Remove animation after it completes
    setTimeout(() => {
      if (williamAvatar) williamAvatar.style.animation = 'none';
    }, 2000);
  }
  
  // Particle effect functions
  function createFireEffect(element) {
    const rect = element.getBoundingClientRect();
    for (let i = 0; i < 15; i++) {
      setTimeout(() => {
        const flame = document.createElement('div');
        flame.textContent = ['🔥', '💥', '✨'][Math.floor(Math.random() * 3)];
        flame.style.cssText = `
          position: fixed;
          left: ${rect.right}px;
          top: ${rect.top + rect.height / 2}px;
          font-size: ${20 + Math.random() * 20}px;
          pointer-events: none;
          z-index: 10000;
          animation: fireParticle 1s ease-out forwards;
        `;
        document.body.appendChild(flame);
        setTimeout(() => flame.remove(), 1000);
      }, i * 80);
    }
  }
  
  function createFartEffect(element) {
    const rect = element.getBoundingClientRect();
    const fartCloud = document.createElement('div');
    fartCloud.textContent = '💨';
    fartCloud.style.cssText = `
      position: fixed;
      left: ${rect.left - 30}px;
      top: ${rect.bottom - 40}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
      animation: fartParticle 1.5s ease-out forwards;
    `;
    document.body.appendChild(fartCloud);
    
    // Add extra stink clouds
    ['💩', '💨', '😷'].forEach((emoji, i) => {
      setTimeout(() => {
        const cloud = document.createElement('div');
        cloud.textContent = emoji;
        cloud.style.cssText = `
          position: fixed;
          left: ${rect.left - 20 + Math.random() * -30}px;
          top: ${rect.bottom - 30 + Math.random() * -20}px;
          font-size: ${25 + Math.random() * 15}px;
          pointer-events: none;
          z-index: 10000;
          animation: fartParticle ${1 + Math.random()}s ease-out forwards;
        `;
        document.body.appendChild(cloud);
        setTimeout(() => cloud.remove(), 1500);
      }, i * 200);
    });
    
    setTimeout(() => fartCloud.remove(), 1500);
  }
  
  function createThrowEffect(element) {
    const rect = element.getBoundingClientRect();
    const projectiles = ['🏀', '⚾', '🎾', '🏈', '⚽', '🍕', '🍎', '🍌'];
    const projectile = document.createElement('div');
    projectile.textContent = projectiles[Math.floor(Math.random() * projectiles.length)];
    projectile.style.cssText = `
      position: fixed;
      left: ${rect.right}px;
      top: ${rect.top + rect.height / 2}px;
      font-size: 30px;
      pointer-events: none;
      z-index: 10000;
      animation: throwParticle 1.2s ease-out forwards;
    `;
    document.body.appendChild(projectile);
    setTimeout(() => projectile.remove(), 1200);
  }
  
  function createBurpEffect(element) {
    const rect = element.getBoundingClientRect();
    const burp = document.createElement('div');
    burp.textContent = '🗣️💨';
    burp.style.cssText = `
      position: fixed;
      left: ${rect.right - 10}px;
      top: ${rect.top + 20}px;
      font-size: 35px;
      pointer-events: none;
      z-index: 10000;
      animation: burpParticle 1s ease-out forwards;
    `;
    document.body.appendChild(burp);
    
    // Add burp text
    setTimeout(() => {
      const text = document.createElement('div');
      text.textContent = 'BURRRP!';
      text.style.cssText = `
        position: fixed;
        left: ${rect.right + 10}px;
        top: ${rect.top}px;
        font-size: 20px;
        font-weight: bold;
        color: #4ade80;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        pointer-events: none;
        z-index: 10000;
        animation: burpParticle 1s ease-out forwards;
      `;
      document.body.appendChild(text);
      setTimeout(() => text.remove(), 1000);
    }, 100);
    
    setTimeout(() => burp.remove(), 1000);
  }
  
  function createSneezeEffect(element) {
    const rect = element.getBoundingClientRect();
    for (let i = 0; i < 10; i++) {
      const sneeze = document.createElement('div');
      sneeze.textContent = ['💦', '💧', '🤧'][Math.floor(Math.random() * 3)];
      const randomX = 50 + Math.random() * 50;
      const randomY = 30 + Math.random() * 30;
      sneeze.style.cssText = `
        position: fixed;
        left: ${rect.right - 10}px;
        top: ${rect.top + 30}px;
        font-size: ${15 + Math.random() * 15}px;
        pointer-events: none;
        z-index: 10000;
        animation: sneezeParticle ${0.8 + Math.random() * 0.4}s ease-out forwards;
        --random-x: ${randomX}px;
        --random-y: ${randomY}px;
      `;
      // Apply random transform using custom animation
      const duration = 0.8 + Math.random() * 0.4;
      sneeze.animate([
        { transform: 'translateX(0) translateY(0) scale(1)', opacity: 1 },
        { transform: `translateX(${randomX}px) translateY(-${randomY}px) scale(0.3)`, opacity: 0 }
      ], {
        duration: duration * 1000,
        easing: 'ease-out',
        fill: 'forwards'
      });
      document.body.appendChild(sneeze);
      setTimeout(() => sneeze.remove(), 1200);
    }
    
    // Add "ACHOO!" text
    const text = document.createElement('div');
    text.textContent = 'ACHOO!';
    text.style.cssText = `
      position: fixed;
      left: ${rect.right + 10}px;
      top: ${rect.top + 20}px;
      font-size: 22px;
      font-weight: bold;
      color: #60a5fa;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
      z-index: 10000;
    `;
    text.animate([
      { transform: 'translateY(0) scale(0.8)', opacity: 1 },
      { transform: 'translateY(-60px) scale(1.5)', opacity: 0 }
    ], {
      duration: 1000,
      easing: 'ease-out',
      fill: 'forwards'
    });
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 1000);
  }
  
  function createExplodeEffect(element) {
    const rect = element.getBoundingClientRect();
    const emojis = ['💥', '⭐', '✨', '💫', '🌟', '🎆', '🎇'];
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        const angle = (Math.PI * 2 * i) / 20;
        const distance = 150;
        const x = Math.cos(angle) * distance;
        const y = Math.sin(angle) * distance;
        particle.style.cssText = `
          position: fixed;
          left: ${rect.left + rect.width / 2}px;
          top: ${rect.top + rect.height / 2}px;
          font-size: ${15 + Math.random() * 15}px;
          pointer-events: none;
          z-index: 10000;
        `;
        // Apply transform using Web Animations API for full browser support
        particle.animate([
          { transform: 'translate(0, 0) scale(1)', opacity: 1 },
          { transform: `translate(${x}px, ${y}px) scale(0.5)`, opacity: 0 }
        ], {
          duration: 1000,
          easing: 'ease-out',
          fill: 'forwards'
        });
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
      }, i * 20);
    }
  }
  
  function createWaterBalloonEffect(element) {
    const rect = element.getBoundingClientRect();
    const waterBalloon = document.createElement('div');
    waterBalloon.textContent = '💧';
    waterBalloon.style.cssText = `
      position: fixed;
      left: ${rect.right}px;
      top: ${rect.top + rect.height / 2}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
      animation: waterBalloonParticle 1.5s ease-out forwards;
    `;
    document.body.appendChild(waterBalloon);
    
    // Create splash effect at the end
    setTimeout(() => {
      const splash = document.createElement('div');
      splash.textContent = '💦';
      splash.style.cssText = `
        position: fixed;
        left: ${rect.right + 200}px;
        top: ${rect.top + rect.height / 2 - 50}px;
        font-size: 50px;
        pointer-events: none;
        z-index: 10000;
        animation: waterSplash 0.6s ease-out forwards;
      `;
      document.body.appendChild(splash);
      
      // Find nearby elements and push them away from splash
      const splashX = rect.right + 200;
      const splashY = rect.top + rect.height / 2 - 50;
      
      const interactiveElements = [
        ...document.querySelectorAll('.quest-card'),
        ...document.querySelectorAll('.btn'),
        ...document.querySelectorAll('.stat-card')
      ];
      
      interactiveElements.forEach(element => {
        const elementRect = element.getBoundingClientRect();
        const elementCenterX = elementRect.left + elementRect.width / 2;
        const elementCenterY = elementRect.top + elementRect.height / 2;
        
        const distance = Math.sqrt(
          Math.pow(elementCenterX - splashX, 2) + 
          Math.pow(elementCenterY - splashY, 2)
        );
        
        // If element is within splash range
        if (distance < 200) {
          const angle = Math.atan2(elementCenterY - splashY, elementCenterX - splashX);
          const pushDistance = 20 * (1 - distance / 200);
          
          const newX = Math.cos(angle) * pushDistance;
          const newY = Math.sin(angle) * pushDistance;
          
          element.style.transition = 'transform 0.3s ease-out';
          element.style.transform = `translate(${newX}px, ${newY}px)`;
          element.style.animation = 'william-wobble 0.5s ease-in-out';
          
          setTimeout(() => {
            element.style.animation = '';
            element.style.transition = 'transform 1s ease-in-out';
            element.style.transform = 'translate(0, 0)';
          }, 500);
        }
      });
      
      setTimeout(() => splash.remove(), 600);
    }, 1050);
    
    setTimeout(() => waterBalloon.remove(), 1500);
  }
  
  function createSlipOutEffect(element) {
    // Add trail of dust clouds as William slips out
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const rect = element.getBoundingClientRect();
        const dust = document.createElement('div');
        dust.textContent = '💨';
        dust.style.cssText = `
          position: fixed;
          left: ${rect.left + (i * 30)}px;
          top: ${rect.bottom - 20}px;
          font-size: 25px;
          pointer-events: none;
          z-index: 9999;
          animation: fartParticle 1s ease-out forwards;
        `;
        document.body.appendChild(dust);
        setTimeout(() => dust.remove(), 1000);
      }, i * 200);
    }
    
    // Add "Wheee!" text
    setTimeout(() => {
      const rect = element.getBoundingClientRect();
      const text = document.createElement('div');
      text.textContent = 'Wheee!';
      text.style.cssText = `
        position: fixed;
        left: ${rect.right + 50}px;
        top: ${rect.top}px;
        font-size: 24px;
        font-weight: bold;
        color: #ffd36e;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        pointer-events: none;
        z-index: 10000;
      `;
      text.animate([
        { transform: 'translateY(0) scale(0.8)', opacity: 1 },
        { transform: 'translateY(-40px) scale(1.2)', opacity: 0 }
      ], {
        duration: 1000,
        easing: 'ease-out',
        fill: 'forwards'
      });
      document.body.appendChild(text);
      setTimeout(() => text.remove(), 1000);
    }, 400);
  }

  // William Collision Detection System
  function setupWilliamCollisionDetection() {
    const williamAvatar = document.getElementById('williamAvatar');
    if (!williamAvatar) return;
    
    // Get all interactive elements that can be bumped
    const interactiveElements = [
      ...document.querySelectorAll('.quest-card'),
      ...document.querySelectorAll('.btn'),
      ...document.querySelectorAll('.stat-card'),
      document.getElementById('weatherToggle'),
      document.getElementById('settingsToggle')
    ].filter(el => el && el !== williamAvatar);
    
    // Check for collisions periodically
    setInterval(() => {
      const williamRect = williamAvatar.getBoundingClientRect();
      
      interactiveElements.forEach(element => {
        if (!element) return;
        
        const elementRect = element.getBoundingClientRect();
        
        // Check if William is colliding with this element
        const isColliding = !(
          williamRect.right < elementRect.left ||
          williamRect.left > elementRect.right ||
          williamRect.bottom < elementRect.top ||
          williamRect.top > elementRect.bottom
        );
        
        if (isColliding) {
          // Calculate push direction based on William's position relative to element
          const williamCenterX = williamRect.left + williamRect.width / 2;
          const williamCenterY = williamRect.top + williamRect.height / 2;
          const elementCenterX = elementRect.left + elementRect.width / 2;
          const elementCenterY = elementRect.top + elementRect.height / 2;
          
          const deltaX = elementCenterX - williamCenterX;
          const deltaY = elementCenterY - williamCenterY;
          
          // Determine primary direction
          const angle = Math.atan2(deltaY, deltaX);
          const pushDistance = 10;
          
          // Apply push effect
          const currentTransform = element.style.transform || '';
          const translateMatch = currentTransform.match(/translate\(([^,]+),\s*([^)]+)\)/);
          
          let currentX = 0, currentY = 0;
          if (translateMatch) {
            currentX = parseFloat(translateMatch[1]) || 0;
            currentY = parseFloat(translateMatch[2]) || 0;
          }
          
          const newX = currentX + Math.cos(angle) * pushDistance;
          const newY = currentY + Math.sin(angle) * pushDistance;
          
          // Apply wobble animation and translation
          element.style.transition = 'transform 0.3s ease-out';
          element.style.transform = `translate(${newX}px, ${newY}px)`;
          
          // Add wobble effect
          element.style.animation = 'william-wobble 0.5s ease-in-out';
          
          // Reset after animation
          setTimeout(() => {
            element.style.animation = '';
            element.style.transition = 'transform 1s ease-in-out';
            element.style.transform = 'translate(0, 0)';
          }, 500);
        }
      });
    }, 100);
  }

  // Weather Effects System
  const weatherContainer = document.getElementById('weatherContainer');
  const weatherLightning = document.getElementById('weatherLightning');
  const weatherToggle = document.getElementById('weatherToggle');
  const weatherMenu = document.getElementById('weatherMenu');
  let currentWeather = 'none';
  let weatherParticles = [];
  let lightningInterval = null;
  
  // Constants
  const WEATHER_STORAGE_KEY = 'williamsWorldWeather';
  const MIN_LIGHTNING_INTERVAL = 5000; // 5 seconds
  const LIGHTNING_INTERVAL_RANGE = 5000; // Additional random 0-5 seconds

  // Create rain
  function createRain() {
    clearWeather();
    const rainCount = 100;
    for (let i = 0; i < rainCount; i++) {
      const drop = document.createElement('div');
      drop.className = 'raindrop';
      drop.style.left = Math.random() * 100 + '%';
      drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
      drop.style.animationDelay = Math.random() * 2 + 's';
      weatherContainer.appendChild(drop);
      weatherParticles.push(drop);
    }
  }

  // Create snow
  function createSnow() {
    clearWeather();
    const snowCount = 50;
    const snowflakes = ['❄', '❅', '❆'];
    for (let i = 0; i < snowCount; i++) {
      const flake = document.createElement('div');
      flake.className = 'snowflake';
      flake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
      flake.style.left = Math.random() * 100 + '%';
      flake.style.fontSize = (Math.random() * 15 + 15) + 'px';
      flake.style.animationDuration = (Math.random() * 3 + 3) + 's';
      flake.style.animationDelay = Math.random() * 3 + 's';
      weatherContainer.appendChild(flake);
      weatherParticles.push(flake);
    }
  }

  // Create clouds
  function createClouds() {
    clearWeather();
    const cloudCount = 8;
    const cloudEmojis = ['☁️', '☁', '🌥'];
    for (let i = 0; i < cloudCount; i++) {
      const cloud = document.createElement('div');
      cloud.className = 'cloud';
      cloud.textContent = cloudEmojis[Math.floor(Math.random() * cloudEmojis.length)];
      cloud.style.top = (Math.random() * 40) + '%';
      cloud.style.fontSize = (Math.random() * 40 + 40) + 'px';
      cloud.style.animationDuration = (Math.random() * 20 + 20) + 's';
      cloud.style.animationDelay = Math.random() * 10 + 's';
      cloud.style.left = '-10%';
      weatherContainer.appendChild(cloud);
      weatherParticles.push(cloud);
    }
  }

  // Create storm (rain + clouds + lightning)
  function createStorm() {
    clearWeather();
    createRain();
    
    // Add some dark clouds
    const cloudCount = 5;
    for (let i = 0; i < cloudCount; i++) {
      const cloud = document.createElement('div');
      cloud.className = 'cloud';
      cloud.textContent = '☁️';
      cloud.style.top = (Math.random() * 30) + '%';
      cloud.style.fontSize = (Math.random() * 50 + 50) + 'px';
      cloud.style.animationDuration = (Math.random() * 15 + 15) + 's';
      cloud.style.animationDelay = Math.random() * 8 + 's';
      cloud.style.left = '-10%';
      cloud.style.opacity = '0.8';
      cloud.style.filter = 'brightness(0.6) drop-shadow(0 0 15px rgba(0, 0, 0, 0.5))';
      weatherContainer.appendChild(cloud);
      weatherParticles.push(cloud);
    }

    // Add lightning effect
    if (lightningInterval) clearInterval(lightningInterval);
    lightningInterval = setInterval(() => {
      if (currentWeather === 'storm') {
        weatherLightning.style.animation = 'lightning 0.4s ease-out';
        setTimeout(() => {
          weatherLightning.style.animation = '';
        }, 400);
      }
    }, MIN_LIGHTNING_INTERVAL + Math.random() * LIGHTNING_INTERVAL_RANGE);
  }

  // Clear all weather
  function clearWeather() {
    weatherParticles.forEach(particle => particle.remove());
    weatherParticles = [];
    if (lightningInterval) {
      clearInterval(lightningInterval);
      lightningInterval = null;
    }
    weatherLightning.style.animation = '';
  }

  // Set weather
  function setWeather(weather) {
    currentWeather = weather;
    
    // Update weather icon
    const weatherIcons = {
      'none': '☀️',
      'rain': '🌧️',
      'snow': '❄️',
      'clouds': '☁️',
      'storm': '⛈️'
    };
    weatherToggle.textContent = weatherIcons[weather];

    // Update active state
    document.querySelectorAll('.weatherOption').forEach(option => {
      option.classList.toggle('active', option.dataset.weather === weather);
    });

    // Apply weather effect
    switch(weather) {
      case 'rain':
        createRain();
        break;
      case 'snow':
        createSnow();
        break;
      case 'clouds':
        createClouds();
        break;
      case 'storm':
        createStorm();
        break;
      case 'none':
      default:
        clearWeather();
        break;
    }

    // Save to localStorage
    localStorage.setItem(WEATHER_STORAGE_KEY, weather);
  }

  // Toggle weather menu
  weatherToggle.addEventListener('click', () => {
    weatherMenu.classList.toggle('show');
  });

  // Weather option click handlers
  document.querySelectorAll('.weatherOption').forEach(option => {
    option.addEventListener('click', () => {
      initAudioOnInteraction();
      audioManager.play('ui.click');
      const weather = option.dataset.weather;
      setWeather(weather);
      weatherMenu.classList.remove('show');
    });
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!weatherToggle.contains(e.target) && !weatherMenu.contains(e.target)) {
      weatherMenu.classList.remove('show');
    }
  });

  // Load saved weather on init
  const savedWeather = localStorage.getItem(WEATHER_STORAGE_KEY) || 'none';
  setWeather(savedWeather);

  // ============================================
  // AUDIO CONTROLS SYSTEM
  // ============================================
  
  const audioToggle = document.getElementById('audioToggle');
  const audioSettings = document.getElementById('audioSettings');
  const musicVolumeSlider = document.getElementById('musicVolume');
  const ambienceVolumeSlider = document.getElementById('ambienceVolume');
  const sfxVolumeSlider = document.getElementById('sfxVolume');
  const reduceSoundCheckbox = document.getElementById('reduceSoundMode');
  
  // Initialize audio on first user interaction
  let audioInitialized = false;
  function initAudioOnInteraction() {
    if (!audioInitialized) {
      audioInitialized = true;
      audioManager.init();
      console.log('Audio initialized on user interaction');
    }
  }
  
  // Initialize on any user interaction (required for mobile)
  document.addEventListener('click', initAudioOnInteraction, { once: true });
  document.addEventListener('touchstart', initAudioOnInteraction, { once: true });
  
  // Update volume display values
  function updateVolumeDisplays() {
    document.getElementById('musicVolumeValue').textContent = musicVolumeSlider.value + '%';
    document.getElementById('ambienceVolumeValue').textContent = ambienceVolumeSlider.value + '%';
    document.getElementById('sfxVolumeValue').textContent = sfxVolumeSlider.value + '%';
  }
  
  // Load saved audio settings into UI
  function loadAudioSettingsUI() {
    musicVolumeSlider.value = Math.round(audioManager.volumes.music * 100);
    ambienceVolumeSlider.value = Math.round(audioManager.volumes.ambience * 100);
    sfxVolumeSlider.value = Math.round(audioManager.volumes.sfx * 100);
    reduceSoundCheckbox.checked = audioManager.reduceSoundMode;
    updateVolumeDisplays();
    updateAudioToggleIcon();
  }
  
  // Update audio toggle icon based on mute state
  function updateAudioToggleIcon() {
    if (audioManager.isMuted) {
      audioToggle.textContent = '🔇';
      audioToggle.classList.add('muted');
    } else {
      audioToggle.textContent = '🔊';
      audioToggle.classList.remove('muted');
    }
  }
  
  // Toggle audio settings panel
  audioToggle.addEventListener('click', (e) => {
    initAudioOnInteraction();
    
    // If shift-click, toggle mute
    if (e.shiftKey) {
      audioManager.toggleMute();
      updateAudioToggleIcon();
      audioManager.play('ui.toggleOn');
      return;
    }
    
    audioSettings.classList.toggle('show');
    if (audioSettings.classList.contains('show')) {
      audioManager.play('ui.panelOpen');
    } else {
      audioManager.play('ui.panelClose');
    }
  });
  
  // Music volume slider
  musicVolumeSlider.addEventListener('input', () => {
    const value = musicVolumeSlider.value / 100;
    audioManager.setVolume('music', value);
    updateVolumeDisplays();
  });
  
  // Ambience volume slider
  ambienceVolumeSlider.addEventListener('input', () => {
    const value = ambienceVolumeSlider.value / 100;
    audioManager.setVolume('ambience', value);
    updateVolumeDisplays();
    
    // Update current weather ambience if playing
    if (currentWeather && currentWeather !== 'none') {
      audioManager.playWeatherAmbience(currentWeather);
    }
  });
  
  // SFX volume slider
  sfxVolumeSlider.addEventListener('input', () => {
    const value = sfxVolumeSlider.value / 100;
    audioManager.setVolume('sfx', value);
    updateVolumeDisplays();
    
    // Play test sound
    audioManager.play('ui.click');
  });
  
  // Reduce sound mode checkbox
  reduceSoundCheckbox.addEventListener('change', () => {
    audioManager.setReduceSoundMode(reduceSoundCheckbox.checked);
    audioManager.play('ui.toggleOn');
  });
  
  // Close audio settings when clicking outside
  document.addEventListener('click', (e) => {
    if (!audioToggle.contains(e.target) && !audioSettings.contains(e.target)) {
      if (audioSettings.classList.contains('show')) {
        audioSettings.classList.remove('show');
        audioManager.play('ui.panelClose');
      }
    }
  });
  
  // Load audio settings on init
  loadAudioSettingsUI();
  
  // Connect weather changes to audio
  const originalSetWeather = setWeather;
  setWeather = function(weather) {
    originalSetWeather(weather);
    
    // Play weather ambience
    if (weather === 'none') {
      audioManager.playWeatherAmbience('sunny');
    } else {
      audioManager.playWeatherAmbience(weather);
    }
  };

  // ============================================
  // WILLIAM EASTER EGG EMOTE SYSTEM
  // ============================================
  
  // Easter Egg Animations (Click-Triggered)
  const easterEggEmotes = [
    { name: 'easter-confetti-sneezus', effect: 'confettiSneeze', duration: 3000 },
    { name: 'easter-banana-slip', effect: 'bananaSlip', duration: 4000 },
    { name: 'easter-bubble-burp', effect: 'bubbleBurp', duration: 3000 },
    { name: 'easter-pie-trap', effect: 'pieTrap', duration: 3000 },
    { name: 'easter-rubber-chicken', effect: 'rubberChicken', duration: 3000 },
    { name: 'easter-hero-landing', effect: 'heroLanding', duration: 2500 },
    { name: 'easter-endless-scarf', effect: 'endlessScarf', duration: 4000 },
    { name: 'easter-frog-crown', effect: 'frogCrown', duration: 3000 },
    { name: 'easter-chipmunk-voice', effect: 'chipmunkVoice', duration: 3000 },
    { name: 'easter-marshmallow-volley', effect: 'marshmallowVolley', duration: 3000 },
    { name: 'easter-hair-tornado', effect: 'hairTornado', duration: 3500 },
    { name: 'easter-tiger-shuffle', effect: 'tigerShuffle', duration: 3000 },
    { name: 'easter-lego-step', effect: 'legoStep', duration: 3000 },
    { name: 'easter-goose-chase', effect: 'gooseChase', duration: 4000 },
    { name: 'easter-sock-chest', effect: 'sockChest', duration: 3500 }
  ];
  
  // State machine for William animations
  let williamState = {
    current: 'idle', // idle, auto-emote, easter-egg, rest
    lastEasterEgg: null,
    clickCount: 0,
    clickTimestamps: [],
    isOnCooldown: false,
    restUntil: null,
    autoEmoteTimer: null,
    nextAutoEmoteTime: null
  };
  
  // Easter Egg Particle Effects
  function createConfettiSneezeEffect(element) {
    const rect = element.getBoundingClientRect();
    const confetti = ['🎊', '🎉', '✨', '⭐', '💫'];
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        const particle = document.createElement('div');
        particle.textContent = confetti[Math.floor(Math.random() * confetti.length)];
        const angle = Math.random() * Math.PI * 2;
        const distance = 80 + Math.random() * 70;
        const x = Math.cos(angle) * distance;
        const y = Math.sin(angle) * distance;
        particle.style.cssText = `
          position: fixed;
          left: ${rect.right - 10}px;
          top: ${rect.top + 40}px;
          font-size: ${20 + Math.random() * 15}px;
          pointer-events: none;
          z-index: 10000;
        `;
        particle.animate([
          { transform: 'translate(0, 0) scale(1)', opacity: 1 },
          { transform: `translate(${x}px, ${y}px) scale(0.3) rotate(${Math.random() * 720}deg)`, opacity: 0 }
        ], { duration: 1000, easing: 'ease-out', fill: 'forwards' });
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
      }, i * 30);
    }
  }
  
  function createBananaSlipEffect(element) {
    const rect = element.getBoundingClientRect();
    const banana = document.createElement('div');
    banana.textContent = '🍌';
    banana.style.cssText = `
      position: fixed;
      left: ${rect.left - 20}px;
      top: ${rect.bottom - 10}px;
      font-size: 30px;
      pointer-events: none;
      z-index: 10000;
    `;
    document.body.appendChild(banana);
    setTimeout(() => banana.remove(), 2000);
    
    // Thumbs up at the end
    setTimeout(() => {
      const thumbsUp = document.createElement('div');
      thumbsUp.textContent = '👍';
      thumbsUp.style.cssText = `
        position: fixed;
        left: ${rect.right + 10}px;
        top: ${rect.top + 20}px;
        font-size: 40px;
        pointer-events: none;
        z-index: 10000;
      `;
      thumbsUp.animate([
        { transform: 'scale(0)', opacity: 0 },
        { transform: 'scale(1.2)', opacity: 1 },
        { transform: 'scale(1)', opacity: 1 }
      ], { duration: 500, easing: 'ease-out' });
      document.body.appendChild(thumbsUp);
      setTimeout(() => thumbsUp.remove(), 1500);
    }, 3000);
  }
  
  function createBubbleBurpEffect(element) {
    const rect = element.getBoundingClientRect();
    const bubble = document.createElement('div');
    bubble.textContent = '💭';
    bubble.style.cssText = `
      position: fixed;
      left: ${rect.right}px;
      top: ${rect.top + 30}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
    `;
    bubble.animate([
      { transform: 'translateY(0) scale(0.8)', opacity: 0.8 },
      { transform: 'translateY(-100px) scale(1.5)', opacity: 0 }
    ], { duration: 2000, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(bubble);
    
    // Sparkles when it pops
    setTimeout(() => {
      const sparkles = ['✨', '⭐', '💫'];
      for (let i = 0; i < 8; i++) {
        const sparkle = document.createElement('div');
        sparkle.textContent = sparkles[Math.floor(Math.random() * sparkles.length)];
        const angle = (Math.PI * 2 * i) / 8;
        const distance = 50;
        const x = Math.cos(angle) * distance;
        const y = Math.sin(angle) * distance;
        sparkle.style.cssText = `
          position: fixed;
          left: ${rect.right}px;
          top: ${rect.top - 70}px;
          font-size: 20px;
          pointer-events: none;
          z-index: 10000;
        `;
        sparkle.animate([
          { transform: 'translate(0, 0) scale(1)', opacity: 1 },
          { transform: `translate(${x}px, ${y}px) scale(0.5)`, opacity: 0 }
        ], { duration: 600, easing: 'ease-out', fill: 'forwards' });
        document.body.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 600);
      }
    }, 1800);
    setTimeout(() => bubble.remove(), 2000);
  }
  
  function createPieTrapEffect(element) {
    const rect = element.getBoundingClientRect();
    const pie = document.createElement('div');
    pie.textContent = '🥧';
    pie.style.cssText = `
      position: fixed;
      left: ${rect.right - 20}px;
      top: ${rect.top + 10}px;
      font-size: 50px;
      pointer-events: none;
      z-index: 10000;
    `;
    pie.animate([
      { transform: 'scale(0) rotate(0deg)', opacity: 0 },
      { transform: 'scale(1.5) rotate(360deg)', opacity: 1 },
      { transform: 'scale(1) rotate(360deg)', opacity: 0 }
    ], { duration: 800, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(pie);
    setTimeout(() => pie.remove(), 800);
  }
  
  function createRubberChickenEffect(element) {
    const rect = element.getBoundingClientRect();
    const chicken = document.createElement('div');
    chicken.textContent = '🐔';
    chicken.style.cssText = `
      position: fixed;
      left: ${rect.right + 10}px;
      top: ${rect.top + 30}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
    `;
    chicken.animate([
      { transform: 'translateY(20px) scale(0)', opacity: 0 },
      { transform: 'translateY(0) scale(1)', opacity: 1 },
      { transform: 'translateY(0) scale(1.1)', opacity: 1 },
      { transform: 'translateY(20px) scale(0)', opacity: 0 }
    ], { duration: 2500, easing: 'ease-in-out', fill: 'forwards' });
    document.body.appendChild(chicken);
    setTimeout(() => chicken.remove(), 2500);
  }
  
  function createHeroLandingEffect(element) {
    const rect = element.getBoundingClientRect();
    const impact = document.createElement('div');
    impact.textContent = '💥';
    impact.style.cssText = `
      position: fixed;
      left: ${rect.left + rect.width / 2 - 20}px;
      top: ${rect.bottom - 10}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
    `;
    impact.animate([
      { transform: 'scale(0)', opacity: 0 },
      { transform: 'scale(1.5)', opacity: 1 },
      { transform: 'scale(0)', opacity: 0 }
    ], { duration: 600, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(impact);
    setTimeout(() => impact.remove(), 600);
  }
  
  function createEndlessScarfEffect(element) {
    const rect = element.getBoundingClientRect();
    for (let i = 0; i < 10; i++) {
      setTimeout(() => {
        const scarf = document.createElement('div');
        scarf.textContent = '🧣';
        scarf.style.cssText = `
          position: fixed;
          left: ${rect.right + (i * 15)}px;
          top: ${rect.top + 40}px;
          font-size: 25px;
          pointer-events: none;
          z-index: 10000;
        `;
        scarf.animate([
          { transform: 'translateX(0) scale(0)', opacity: 0 },
          { transform: 'translateX(0) scale(1)', opacity: 1 },
          { transform: 'translateX(0) scale(1)', opacity: 0.5 }
        ], { duration: 300, easing: 'ease-out', fill: 'forwards' });
        document.body.appendChild(scarf);
        setTimeout(() => scarf.remove(), 3000);
      }, i * 200);
    }
  }
  
  function createFrogCrownEffect(element) {
    const rect = element.getBoundingClientRect();
    const frog = document.createElement('div');
    frog.textContent = '🐸';
    frog.style.cssText = `
      position: fixed;
      left: ${rect.left + rect.width / 2 - 20}px;
      top: ${rect.top - 40}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
    `;
    frog.animate([
      { transform: 'translateY(20px) scale(0)', opacity: 0 },
      { transform: 'translateY(0) scale(1)', opacity: 1 }
    ], { duration: 500, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(frog);
    setTimeout(() => frog.remove(), 2500);
    
    // Ribbit text
    setTimeout(() => {
      const text = document.createElement('div');
      text.textContent = 'Ribbit!';
      text.style.cssText = `
        position: fixed;
        left: ${rect.right + 10}px;
        top: ${rect.top}px;
        font-size: 20px;
        font-weight: bold;
        color: #4ade80;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        pointer-events: none;
        z-index: 10000;
      `;
      text.animate([
        { transform: 'scale(0)', opacity: 0 },
        { transform: 'scale(1.2)', opacity: 1 },
        { transform: 'scale(1)', opacity: 0 }
      ], { duration: 1000, easing: 'ease-out', fill: 'forwards' });
      document.body.appendChild(text);
      setTimeout(() => text.remove(), 1000);
    }, 1000);
  }
  
  function createChipmunkVoiceEffect(element) {
    const rect = element.getBoundingClientRect();
    const notes = ['🎵', '🎶', '🎼'];
    for (let i = 0; i < 6; i++) {
      setTimeout(() => {
        const note = document.createElement('div');
        note.textContent = notes[Math.floor(Math.random() * notes.length)];
        note.style.cssText = `
          position: fixed;
          left: ${rect.right + (i * 10)}px;
          top: ${rect.top + 20}px;
          font-size: ${20 + Math.random() * 10}px;
          pointer-events: none;
          z-index: 10000;
        `;
        note.animate([
          { transform: 'translateY(0) scale(0.5)', opacity: 1 },
          { transform: 'translateY(-60px) scale(1)', opacity: 0 }
        ], { duration: 1500, easing: 'ease-out', fill: 'forwards' });
        document.body.appendChild(note);
        setTimeout(() => note.remove(), 1500);
      }, i * 200);
    }
  }
  
  function createMarshmallowVolleyEffect(element) {
    const rect = element.getBoundingClientRect();
    const marshmallow = document.createElement('div');
    marshmallow.textContent = '🍡';
    marshmallow.style.cssText = `
      position: fixed;
      left: ${rect.right}px;
      top: ${rect.top + rect.height / 2}px;
      font-size: 30px;
      pointer-events: none;
      z-index: 10000;
    `;
    marshmallow.animate([
      { transform: 'translateX(0) translateY(0)', opacity: 1 },
      { transform: 'translateX(150px) translateY(-60px)', opacity: 1 },
      { transform: 'translateX(0) translateY(0)', opacity: 1 }
    ], { duration: 1500, easing: 'ease-in-out', fill: 'forwards' });
    document.body.appendChild(marshmallow);
    setTimeout(() => marshmallow.remove(), 1500);
  }
  
  function createHairTornadoEffect(element) {
    const rect = element.getBoundingClientRect();
    const tornado = document.createElement('div');
    tornado.textContent = '🌪️';
    tornado.style.cssText = `
      position: fixed;
      left: ${rect.left + rect.width / 2 - 20}px;
      top: ${rect.top - 50}px;
      font-size: 50px;
      pointer-events: none;
      z-index: 10000;
    `;
    tornado.animate([
      { transform: 'scale(0) rotate(0deg)', opacity: 0 },
      { transform: 'scale(1) rotate(360deg)', opacity: 1 },
      { transform: 'scale(1) rotate(720deg)', opacity: 1 },
      { transform: 'scale(0) rotate(1080deg)', opacity: 0 }
    ], { duration: 2000, easing: 'ease-in-out', fill: 'forwards' });
    document.body.appendChild(tornado);
    setTimeout(() => tornado.remove(), 2000);
  }
  
  function createTigerShuffleEffect(element) {
    const rect = element.getBoundingClientRect();
    const pawPrints = ['🐾'];
    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        const paw = document.createElement('div');
        paw.textContent = pawPrints[0];
        paw.style.cssText = `
          position: fixed;
          left: ${rect.left + rect.width / 2 + (i % 2 === 0 ? -30 : 30)}px;
          top: ${rect.bottom - 20 + (i * 10)}px;
          font-size: 25px;
          pointer-events: none;
          z-index: 9999;
        `;
        paw.animate([
          { transform: 'scale(0)', opacity: 0 },
          { transform: 'scale(1)', opacity: 1 },
          { transform: 'scale(1)', opacity: 0 }
        ], { duration: 800, easing: 'ease-out', fill: 'forwards' });
        document.body.appendChild(paw);
        setTimeout(() => paw.remove(), 800);
      }, i * 150);
    }
  }
  
  function createLegoStepEffect(element) {
    const rect = element.getBoundingClientRect();
    const lego = document.createElement('div');
    lego.textContent = '🧱';
    lego.style.cssText = `
      position: fixed;
      left: ${rect.left + rect.width / 2 - 15}px;
      top: ${rect.bottom - 10}px;
      font-size: 30px;
      pointer-events: none;
      z-index: 10000;
    `;
    document.body.appendChild(lego);
    setTimeout(() => lego.remove(), 2500);
    
    // "OUCH!" text
    const text = document.createElement('div');
    text.textContent = 'OUCH!';
    text.style.cssText = `
      position: fixed;
      left: ${rect.right + 10}px;
      top: ${rect.top}px;
      font-size: 24px;
      font-weight: bold;
      color: #ef4444;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
      z-index: 10000;
    `;
    text.animate([
      { transform: 'scale(0)', opacity: 0 },
      { transform: 'scale(1.3)', opacity: 1 },
      { transform: 'scale(1)', opacity: 0 }
    ], { duration: 1000, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(text);
    setTimeout(() => text.remove(), 1000);
  }
  
  function createGooseChaseEffect(element) {
    const rect = element.getBoundingClientRect();
    const goose = document.createElement('div');
    goose.textContent = '🦆';
    goose.style.cssText = `
      position: fixed;
      left: ${rect.right + 20}px;
      top: ${rect.top + rect.height / 2 - 20}px;
      font-size: 40px;
      pointer-events: none;
      z-index: 10000;
    `;
    goose.animate([
      { transform: 'translateX(0) scale(1)', opacity: 1 },
      { transform: 'translateX(-50px) scale(1.1)', opacity: 1 },
      { transform: 'translateX(0) scale(1)', opacity: 1 }
    ], { duration: 2000, easing: 'ease-in-out', fill: 'forwards' });
    document.body.appendChild(goose);
    
    // Feather at the end
    setTimeout(() => {
      const feather = document.createElement('div');
      feather.textContent = '🪶';
      feather.style.cssText = `
        position: fixed;
        left: ${rect.right + 20}px;
        top: ${rect.top + rect.height / 2 - 20}px;
        font-size: 30px;
        pointer-events: none;
        z-index: 10000;
      `;
      feather.animate([
        { transform: 'translateY(0) rotate(0deg) scale(0)', opacity: 0 },
        { transform: 'translateY(-50px) rotate(360deg) scale(1)', opacity: 1 }
      ], { duration: 1000, easing: 'ease-out', fill: 'forwards' });
      document.body.appendChild(feather);
      setTimeout(() => feather.remove(), 2000);
    }, 2500);
    
    setTimeout(() => goose.remove(), 3500);
  }
  
  function createSockChestEffect(element) {
    const rect = element.getBoundingClientRect();
    const chest = document.createElement('div');
    chest.textContent = '🧦🧦🧦';
    chest.style.cssText = `
      position: fixed;
      left: ${rect.right}px;
      top: ${rect.top + 20}px;
      font-size: 35px;
      pointer-events: none;
      z-index: 10000;
    `;
    chest.animate([
      { transform: 'translateY(20px) scale(0)', opacity: 0 },
      { transform: 'translateY(0) scale(1.2)', opacity: 1 },
      { transform: 'translateY(-10px) scale(1)', opacity: 1 }
    ], { duration: 800, easing: 'ease-out', fill: 'forwards' });
    document.body.appendChild(chest);
    setTimeout(() => chest.remove(), 2500);
  }
  
  // Call particle effect based on emote name
  function triggerEasterEggEffect(effectName, element) {
    const effects = {
      confettiSneeze: createConfettiSneezeEffect,
      bananaSlip: createBananaSlipEffect,
      bubbleBurp: createBubbleBurpEffect,
      pieTrap: createPieTrapEffect,
      rubberChicken: createRubberChickenEffect,
      heroLanding: createHeroLandingEffect,
      endlessScarf: createEndlessScarfEffect,
      frogCrown: createFrogCrownEffect,
      chipmunkVoice: createChipmunkVoiceEffect,
      marshmallowVolley: createMarshmallowVolleyEffect,
      hairTornado: createHairTornadoEffect,
      tigerShuffle: createTigerShuffleEffect,
      legoStep: createLegoStepEffect,
      gooseChase: createGooseChaseEffect,
      sockChest: createSockChestEffect
    };
    
    if (effects[effectName]) {
      effects[effectName](element);
    }
  }
  
  // Apply Easter egg emote
  function applyEasterEggEmote() {
    const williamAvatar = document.getElementById('williamAvatar');
    if (!williamAvatar || williamState.current === 'rest') return;
    
    // Get available emotes (exclude last played for no immediate repeats)
    let availableEmotes = easterEggEmotes;
    if (williamState.lastEasterEgg) {
      availableEmotes = easterEggEmotes.filter(e => e.name !== williamState.lastEasterEgg);
    }
    
    // Pick random Easter egg
    const emote = availableEmotes[Math.floor(Math.random() * availableEmotes.length)];
    williamState.lastEasterEgg = emote.name;
    williamState.current = 'easter-egg';
    
    // Remove any existing animation
    williamAvatar.style.animation = 'none';
    void williamAvatar.offsetWidth;
    
    // Apply the Easter egg animation
    williamAvatar.style.animation = `${emote.name} ${emote.duration}ms ease-in-out`;
    
    // Trigger particle effect
    triggerEasterEggEffect(emote.effect, williamAvatar);
    
    // Return to idle after animation completes
    setTimeout(() => {
      williamAvatar.style.animation = 'none';
      williamState.current = 'idle';
      
      // If auto-emote was scheduled during Easter egg, reschedule it
      if (williamState.nextAutoEmoteTime && Date.now() > williamState.nextAutoEmoteTime) {
        scheduleNextAutoEmote();
      }
    }, emote.duration);
  }
  
  // Check for anti-spam (5+ clicks in ~3 seconds)
  function checkAntiSpam() {
    const now = Date.now();
    williamState.clickTimestamps = williamState.clickTimestamps.filter(t => now - t < 3000);
    
    if (williamState.clickTimestamps.length >= 5) {
      enterRestState();
      return true;
    }
    return false;
  }
  
  // Enter rest state (60 second break)
  function enterRestState() {
    const williamAvatar = document.getElementById('williamAvatar');
    const restOverlay = document.getElementById('williamRestOverlay');
    if (!williamAvatar || !restOverlay) return;
    
    williamState.current = 'rest';
    williamState.restUntil = Date.now() + 60000; // 60 seconds
    williamState.clickTimestamps = [];
    
    // Clear auto-emote timer
    if (williamState.autoEmoteTimer) {
      clearTimeout(williamState.autoEmoteTimer);
      williamState.autoEmoteTimer = null;
    }
    
    // Apply rest animation
    williamAvatar.style.animation = 'none';
    void williamAvatar.offsetWidth;
    williamAvatar.style.animation = 'easter-rest-state 3s ease-in-out infinite';
    
    // Show rest overlay
    restOverlay.classList.add('show');
    
    // Countdown timer
    const countdownEl = document.getElementById('restCountdown');
    const countdownInterval = setInterval(() => {
      const remaining = Math.ceil((williamState.restUntil - Date.now()) / 1000);
      if (countdownEl) countdownEl.textContent = Math.max(0, remaining);
      
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        exitRestState();
      }
    }, 1000);
  }
  
  // Exit rest state
  function exitRestState() {
    const williamAvatar = document.getElementById('williamAvatar');
    const restOverlay = document.getElementById('williamRestOverlay');
    if (!williamAvatar || !restOverlay) return;
    
    williamState.current = 'idle';
    williamState.restUntil = null;
    
    // Remove rest animation
    williamAvatar.style.animation = 'none';
    
    // Hide rest overlay
    restOverlay.classList.remove('show');
    
    // Resume auto-emote cycle
    scheduleNextAutoEmote();
  }
  
  // Handle William avatar click
  function handleWilliamClick() {
    initAudioOnInteraction(); // Initialize audio on first interaction
    
    if (williamState.current === 'rest') {
      // During rest, just show a tiny blink (do nothing for now)
      return;
    }
    
    // Always play tap sound first
    audioManager.playWilliamTap();
    
    // Track click for anti-spam
    williamState.clickTimestamps.push(Date.now());
    
    // Check for spam
    if (checkAntiSpam()) {
      return;
    }
    
    // Check cooldown
    if (williamState.isOnCooldown) {
      return;
    }
    
    // Play Easter egg sound
    audioManager.playWilliamEasterEgg();
    
    // Trigger Easter egg emote
    applyEasterEggEmote();
    
    // Set cooldown (1-2 seconds random)
    williamState.isOnCooldown = true;
    const cooldownDuration = 1000 + Math.random() * 1000; // 1-2 seconds
    setTimeout(() => {
      williamState.isOnCooldown = false;
    }, cooldownDuration);
  }
  
  // Schedule next auto-emote
  function scheduleNextAutoEmote() {
    // Clear existing timer
    if (williamState.autoEmoteTimer) {
      clearTimeout(williamState.autoEmoteTimer);
    }
    
    // Schedule next emote in 10 seconds
    williamState.nextAutoEmoteTime = Date.now() + 10000;
    williamState.autoEmoteTimer = setTimeout(() => {
      // Only play if not in Easter egg or rest state
      if (williamState.current === 'idle') {
        applyRandomWilliamAnimation();
      }
      
      // Schedule next one
      scheduleNextAutoEmote();
    }, 10000);
  }
  
  // Start the animation timer (every 10 seconds for Easter egg unlock window) - only if element exists
  if (document.getElementById('williamAvatar')) {
    const williamAvatar = document.getElementById('williamAvatar');
    
    // Add click handler
    williamAvatar.addEventListener('click', handleWilliamClick);
    williamAvatar.addEventListener('touchend', (e) => {
      e.preventDefault();
      handleWilliamClick();
    });
    
    // Add glow class for affordance
    williamAvatar.classList.add('clickable-glow');
    
    // Trigger the first animation after 1 second
    setTimeout(applyRandomWilliamAnimation, 1000);
    
    // Start the 10-second cycle
    scheduleNextAutoEmote();

    // Setup collision detection after DOM is ready
    setTimeout(setupWilliamCollisionDetection, 100);
  }

  // INIT
  applyAssets();
  renderTasks();
  setupQuestCheckboxes();
  updateHeader();
  
  // ============================================
  // MORNING MISSION TIMER LOOP
  // ============================================
  
  // Update timer every second, but only when needed
  let missionTimerInterval = setInterval(() => {
    const now = getChicagoTime();
    const hour = now.getHours();
    
    // Only run during relevant hours (5 AM to 9 AM for some buffer)
    if (hour >= 5 && hour <= 9) {
      if (isInMorningWindow()) {
        updateMorningMissionUI();
        checkMorningMissionStatus();
      } else if (isMorningDeadlinePassed() && hour < 9) {
        const missionState = getTodayMissionState();
        if (missionState.status !== 'completed' && missionState.status !== 'failed') {
          checkMorningMissionStatus();
        }
      }
    }
  }, 1000);
  
  // Initial status check
  checkMorningMissionStatus();
</script>

</body>
</html>
